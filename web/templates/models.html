{% extends "base.html" %}

{% block title %}Model Performance - College Baseball Predictor{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-start">
    <div>
        <h1 class="h3">
            <i class="bi bi-gear"></i> Model Performance
        </h1>
        <p class="text-muted">Win probability models, totals predictions, and ensemble analysis</p>
    </div>
    <a href="/models/trends" class="btn btn-outline-primary">
        <i class="bi bi-graph-up-arrow"></i> Accuracy Trends
    </a>
</div>

{# ── Section 1: Model Leaderboard + Meta-Ensemble ── #}
<div class="row">
    <!-- Model Accuracy Leaderboard -->
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header bg-maroon">
                <i class="bi bi-trophy"></i> Win Probability — Model Leaderboard
            </div>
            <div class="card-body">
                {% if model_data and model_data[0].accuracy %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th class="text-center">7-Day</th>
                                <th class="text-center">All-Time</th>
                                <th class="text-center">Trend</th>
                                <th class="text-center">Games</th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Sort by all-time accuracy descending #}
                            {% for model in model_data|sort(attribute='accuracy.all_time_accuracy', reverse=true) if model.accuracy and model.accuracy.all_time_accuracy %}
                            <tr class="{% if model.name == 'meta_ensemble' %}table-active{% endif %}">
                                <td>
                                    {% if model.name == 'meta_ensemble' %}<i class="bi bi-stars text-warning"></i> {% endif %}
                                    <strong>{{ model.name }}</strong>
                                </td>
                                <td class="text-center">
                                    {% if model.accuracy.recent_accuracy %}
                                    <span class="{% if model.accuracy.recent_accuracy > 0.70 %}text-success fw-bold{% elif model.accuracy.recent_accuracy > 0.55 %}text-success{% elif model.accuracy.recent_accuracy < 0.45 %}text-danger{% endif %}">
                                        {{ (model.accuracy.recent_accuracy * 100)|round(1) }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="{% if model.accuracy.all_time_accuracy > 0.70 %}text-success fw-bold{% elif model.accuracy.all_time_accuracy > 0.65 %}text-success{% endif %}">
                                        {{ (model.accuracy.all_time_accuracy * 100)|round(1) }}%
                                    </span>
                                </td>
                                <td class="text-center">
                                    {% if model.accuracy.recent_accuracy and model.accuracy.all_time_accuracy %}
                                        {% set delta = (model.accuracy.recent_accuracy - model.accuracy.all_time_accuracy) * 100 %}
                                        {% if delta > 1 %}
                                        <span class="badge bg-success"><i class="bi bi-arrow-up"></i> +{{ delta|round(1) }}</span>
                                        {% elif delta < -1 %}
                                        <span class="badge bg-danger"><i class="bi bi-arrow-down"></i> {{ delta|round(1) }}</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ '%+.1f'|format(delta) }}</span>
                                        {% endif %}
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{{ model.accuracy.all_time_predictions }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2 text-muted">No accuracy data yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Meta-Ensemble Feature Importance -->
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header" style="background-color: #7c3aed; color: white;">
                <i class="bi bi-stars"></i> Meta-Ensemble
            </div>
            <div class="card-body">
                {% if meta_feature_importance %}
                <p class="text-muted small mb-2">
                    XGBoost + Logistic Regression stacking model. Trained on <strong>{{ meta_training_size }}</strong> games
                    (walk-forward validation). Evaluated on {{ meta_accuracy.get('meta_ensemble', {}).get('total', '?') }} graded predictions.
                </p>
                {% set max_imp = meta_feature_importance.values()|list|first if meta_feature_importance else 1 %}
                {% set top_features = meta_feature_importance.items()|list %}
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th class="text-center" style="width: 60px;">Weight</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            {# Show top 10 features, collapse the rest #}
                            {% for name, imp in top_features[:10] %}
                            <tr>
                                <td class="small">{{ name }}</td>
                                <td class="text-center small">{{ (imp * 100)|round(1) }}%</td>
                                <td style="width: 40%;">
                                    <div class="progress" style="height: 14px;">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ (imp / max_imp * 100)|round(1) }}%; background-color: #7c3aed;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if top_features|length > 10 %}
                <div class="mt-2">
                    <a class="text-muted small" data-bs-toggle="collapse" href="#moreFeatures" role="button" aria-expanded="false">
                        <i class="bi bi-chevron-down"></i> {{ top_features|length - 10 }} more features
                    </a>
                    <div class="collapse mt-1" id="moreFeatures">
                        <table class="table table-sm table-borderless small mb-0">
                            <tbody>
                                {% for name, imp in top_features[10:] %}
                                <tr>
                                    <td>{{ name }}</td>
                                    <td class="text-end">{{ (imp * 100)|round(1) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <p class="text-muted">Meta-ensemble not yet trained. Run: <code>python3 scripts/train_meta_ensemble.py</code></p>
                {% endif %}

                {# Legacy weights collapsed #}
                <div class="mt-3 pt-2 border-top">
                    <a class="text-muted small" data-bs-toggle="collapse" href="#legacyWeights" role="button" aria-expanded="false">
                        <i class="bi bi-chevron-down"></i> Legacy static ensemble weights
                    </a>
                    <div class="collapse mt-2" id="legacyWeights">
                        <table class="table table-sm table-borderless small mb-0">
                            <tbody>
                                {% for model in model_data|sort(attribute='weight', reverse=true) if model.weight > 0 %}
                                <tr>
                                    <td>{{ model.name }}</td>
                                    <td class="text-end">{{ model.weight_pct|round(1) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        {# Calibration — only show if any model has non-default values #}
        {% if has_active_calibration and calibration_report %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-sliders"></i> Calibration (Platt)
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm table-hover mb-0">
                        <thead>
                            <tr><th>Model</th><th class="text-center">a</th><th class="text-center">b</th><th class="text-center">Samples</th></tr>
                        </thead>
                        <tbody>
                            {% for row in calibration_report %}
                            {% if (row.a - 1.0)|abs > 0.001 or row.b|abs > 0.001 %}
                            <tr>
                                <td>{{ row.model_name }}</td>
                                <td class="text-center">{{ '%.3f'|format(row.a) }}</td>
                                <td class="text-center">{{ '%.3f'|format(row.b) }}</td>
                                <td class="text-center"><span class="badge bg-secondary">{{ row.n_samples }}</span></td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <small class="text-muted"><code>a</code> scales confidence, <code>b</code> is bias correction.</small>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{# ── Section 2: Model Descriptions ── #}
<div class="card">
    <div class="card-header">
        <i class="bi bi-book"></i> Model Descriptions
        <small class="text-muted ms-2">Click to expand</small>
    </div>
    <div class="card-body p-0">
        <div class="accordion accordion-flush" id="modelDescriptions">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-meta">
                        <span class="badge bg-primary me-2">★</span> Meta-Ensemble <small class="text-muted ms-2">— XGBoost stacking model that learns optimal blending</small>
                    </button>
                </h2>
                <div id="desc-meta" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Trained stacking model that learns the optimal way to combine all 14 models. Uses XGBoost and Logistic Regression to learn <em>when</em> to trust each model based on context.</p>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>20 Input Features:</strong>
                                <ul>
                                    <li><em>Model Predictions (14):</em> Home win probability from each base model</li>
                                    <li><em>Agreement (3):</em> Home-vote count, average probability, max-min spread</li>
                                    <li><em>Context (3):</em> Elo diff, same-conference flag, any-team-ranked flag</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <strong>Validation:</strong>
                                <ul class="mb-0">
                                    <li>Walk-forward only (train on past, test on future)</li>
                                    <li>No random cross-validation (prevents data leakage)</li>
                                    <li>Re-trained weekly as more games accumulate</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-pear">
                        PEAR <small class="text-muted ms-2">— External composite ratings from PEARatings.com</small>
                    </button>
                </h2>
                <div id="desc-pear" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>PEAR Ratings composite — uses external TSR/ELO/fWAR metrics from PEARatings.com. Independent data source provides diversity to the ensemble.</p>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-quality">
                        Quality <small class="text-muted ms-2">— Z-scored batting/pitching quality + dominance ratio</small>
                    </button>
                </h2>
                <div id="desc-quality" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Advanced quality metrics — z-scored batting/pitching quality indexes combined with a dominance ratio. Captures overall team quality independent of win/loss record.</p>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-neural">
                        Neural Network <small class="text-muted ms-2">— PyTorch deep learning on 81 features</small>
                    </button>
                </h2>
                <div id="desc-neural" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Deep neural network (PyTorch) trained on 6,000+ historical games + 2026 season data. Two-phase training: base training on historical, then fine-tuned on recent games.</p>
                        <strong>81 Features:</strong> Team strength (Elo, win%, form), batting (AVG, OBP, SLG, OPS, wRC+, wOBA, ISO), pitching (ERA, WHIP, K/9, FIP, xFIP, SIERA), weather, and game context.
                        <br><strong>Architecture:</strong> 81→128→64→32→1 (ReLU + dropout)
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-elo">
                        Elo <small class="text-muted ms-2">— Chess-style rating system with margin-of-victory</small>
                    </button>
                </h2>
                <div id="desc-elo" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Ratings update after each game based on result, margin, and opponent strength. Preseason ratings seeded from D1Baseball rankings + conference tiers.</p>
                        <strong>Parameters:</strong> K-factor 32, home advantage +50 Elo, logistic win probability curve.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-prior">
                        Prior <small class="text-muted ms-2">— Bayesian prior from preseason rankings</small>
                    </button>
                </h2>
                <div id="desc-prior" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Bayesian prior model — especially useful early season. Uses D1Baseball preseason rankings, historical program strength (3 seasons), conference tier priors, and preseason poll vote counts. Decays as real data accumulates.</p>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-xgboost">
                        XGBoost / LightGBM <small class="text-muted ms-2">— Gradient boosted trees on 81 features</small>
                    </button>
                </h2>
                <div id="desc-xgboost" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Same 81 features as the neural network but using decision tree ensembles. XGBoost uses level-wise growth; LightGBM uses leaf-wise growth. Both trained on ~6,184 historical games with recency weighting.</p>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-pitching">
                        Pitching <small class="text-muted ms-2">— Staff quality model v2</small>
                    </button>
                </h2>
                <div id="desc-pitching" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Uses team pitching/batting quality tables rather than identifying specific starters. Day-of-week blending accounts for rotation patterns (ace Fri 85%, bullpen Sun 45%).</p>
                        <strong>Pitching:</strong> Rotation ERA/WHIP/K9, bullpen quality, ace metrics, staff depth, fragility.
                        <br><strong>Batting:</strong> Lineup OPS/wOBA/wRC+, ISO, BABIP, K%/BB%.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-pythagorean">
                        Pythagorean <small class="text-muted ms-2">— Bill James' run differential formula</small>
                    </button>
                </h2>
                <div id="desc-pythagorean" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        Estimates true team strength from run production (runs scored vs allowed) rather than win/loss record. Exponent 1.83 for college baseball.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-poisson">
                        Poisson <small class="text-muted ms-2">— Run-scoring probability matrix</small>
                    </button>
                </h2>
                <div id="desc-poisson" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        Models runs as Poisson random variables. Builds a full score probability matrix for O/U and run line calculations. Adjusted for batting/pitching quality and home advantage (+0.3 runs).
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-log5">
                        Log5 <small class="text-muted ms-2">— Bill James head-to-head formula</small>
                    </button>
                </h2>
                <div id="desc-log5" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        Calculates head-to-head win probability from each team's winning percentage, adjusting for the fact that both teams' records include games against varying opposition. Uses home/away splits and SOS adjustment.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-advanced">
                        Advanced <small class="text-muted ms-2">— Multi-factor with opponent adjustments</small>
                    </button>
                </h2>
                <div id="desc-advanced" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        Game-results-based model with opponent-adjusted win%, run differential, SOS, recency weighting (exponential decay over last 15 games), and recent form (last 5).
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-conference">
                        Conference <small class="text-muted ms-2">— Conference strength tiers</small>
                    </button>
                </h2>
                <div id="desc-conference" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        Adjusts predictions based on conference strength tiers (SEC, ACC, Big 12, etc.), cross-conference win rates, and team conference standing.
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-ensemble">
                        Ensemble (Legacy) <small class="text-muted ms-2">— Dynamic weighted combination</small>
                    </button>
                </h2>
                <div id="desc-ensemble" class="accordion-collapse collapse">
                    <div class="accordion-body small">
                        <p>Weighted average of all model probabilities with auto-adjusting weights (exponential decay, half-life ~30 predictions). 3% minimum weight floor.</p>
                        <div class="alert alert-warning py-1 mb-0 small">
                            <strong>Superseded</strong> by Meta-Ensemble for win probability. Kept for comparison and fallback.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# ── Section 3: Totals Predictions ── #}
<div class="row mt-4">
    <div class="col-lg-5">
        <div class="card">
            <div class="card-header" style="background-color: #2563eb; color: white;">
                <i class="bi bi-graph-up"></i> Runs Ensemble v2 (Totals)
            </div>
            <div class="card-body">
                <p class="text-muted small mb-2">Poisson + Advanced blend with Negative Binomial O/U and game-context variance adjustment</p>
                
                {% if runs_weights %}
                <div class="table-responsive">
                    <table class="table table-sm mb-2">
                        <tbody>
                            {% for name, weight in runs_weights.items()|sort(attribute='1', reverse=true) %}
                            <tr>
                                <td><strong>{{ name }}</strong></td>
                                <td class="text-center" style="width: 60px;">{{ (weight * 100)|round(0) }}%</td>
                                <td style="width: 50%;">
                                    <div class="progress" style="height: 14px;">
                                        <div class="progress-bar" role="progressbar"
                                             style="width: {{ weight * 100 }}%; background-color: #2563eb;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Runs ensemble weights not available</p>
                {% endif %}

                {% if totals_no_line and totals_no_line.total > 0 %}
                <div class="border-top pt-2 mt-2">
                    <small class="text-muted fw-bold">No-Line Games ({{ totals_no_line.total }}):</small>
                    <div class="row text-center mt-1">
                        <div class="col-4">
                            <strong>{{ totals_no_line.mae }}</strong>
                            <br><small class="text-muted">MAE</small>
                        </div>
                        <div class="col-4">
                            <strong>{{ totals_no_line.avg_projected }}</strong>
                            <br><small class="text-muted">Avg Proj</small>
                        </div>
                        <div class="col-4">
                            <strong>{{ totals_no_line.avg_actual }}</strong>
                            <br><small class="text-muted">Avg Actual</small>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-7">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> Totals O/U Accuracy
            </div>
            <div class="card-body">
                {% if totals_overall and totals_overall.total > 0 %}
                <div class="row mb-3">
                    <div class="col-4 text-center">
                        <h3 class="mb-0 {% if totals_overall.correct / (totals_overall.correct + totals_overall.incorrect) > 0.52 %}text-success{% else %}text-warning{% endif %}">
                            {{ ((totals_overall.correct / (totals_overall.correct + totals_overall.incorrect)) * 100)|round(1) }}%
                        </h3>
                        <small class="text-muted">Overall</small>
                    </div>
                    <div class="col-4 text-center">
                        <h3 class="mb-0 text-success">{{ totals_overall.correct }}</h3>
                        <small class="text-muted">Correct</small>
                    </div>
                    <div class="col-4 text-center">
                        <h3 class="mb-0 text-danger">{{ totals_overall.incorrect }}</h3>
                        <small class="text-muted">Wrong</small>
                    </div>
                </div>
                
                <div class="row">
                    {% if totals_by_type %}
                    <div class="col-md-6">
                        <h6 class="mb-2">By Direction:</h6>
                        {% for row in totals_by_type %}
                        <div class="mb-1">
                            <span class="badge {% if row.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ row.prediction }}
                            </span>
                            {{ row.correct }}/{{ row.total }}
                            ({{ ((row.correct / row.total) * 100)|round(0) if row.total > 0 else 0 }}%)
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    {% if totals_by_edge %}
                    <div class="col-md-6">
                        <h6 class="mb-2">By Edge:</h6>
                        <table class="table table-sm table-borderless mb-0">
                            <tbody>
                                {% for row in totals_by_edge %}
                                <tr>
                                    <td class="small">{{ row.edge_bucket }}</td>
                                    <td class="text-center small">{{ row.correct }}/{{ row.total }}</td>
                                    <td class="text-end">
                                        <span class="{% if row.total > 0 and row.correct / row.total > 0.55 %}text-success{% elif row.total > 0 and row.correct / row.total < 0.45 %}text-danger{% endif %}">
                                            {{ ((row.correct / row.total) * 100)|round(0) if row.total > 0 else 0 }}%
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2 text-muted">No totals predictions tracked yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# ── Section 4: Totals MAE + O/U Split ── #}
{% if totals_mae_by_model %}
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-rulers"></i> MAE by Totals Model</div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Model</th><th class="text-center">Games</th><th class="text-center">MAE</th><th class="text-center">7-Day</th><th class="text-center">Trend</th></tr></thead>
                    <tbody>
                    {% for row in totals_mae_by_model %}
                    <tr>
                        <td>{{ row.model_name }}</td>
                        <td class="text-center">{{ row.n }}</td>
                        <td class="text-center"><strong>{{ row.mae }}</strong></td>
                        <td class="text-center">
                            {% if row.model_name in totals_mae_weekly %}
                            {{ totals_mae_weekly[row.model_name].mae }}
                            {% else %}<span class="text-muted">—</span>{% endif %}
                        </td>
                        <td class="text-center">
                            {% if row.model_name in totals_mae_weekly %}
                                {% set delta = row.mae - totals_mae_weekly[row.model_name].mae %}
                                {% if delta > 0.05 %}
                                <span class="badge bg-success" title="Weekly better than all-time"><i class="bi bi-arrow-up"></i></span>
                                {% elif delta < -0.05 %}
                                <span class="badge bg-danger" title="Weekly worse than all-time"><i class="bi bi-arrow-down"></i></span>
                                {% else %}
                                <span class="badge bg-secondary">—</span>
                                {% endif %}
                            {% else %}<span class="text-muted">—</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header"><i class="bi bi-arrow-up-down"></i> O/U Hit Rate by Model</div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead><tr><th>Model</th><th class="text-center">Direction</th><th class="text-center">Record</th><th class="text-center">Hit%</th><th class="text-center">7-Day</th></tr></thead>
                    <tbody>
                    {% for row in totals_ou_split %}
                    <tr>
                        <td>{{ row.model_name }}</td>
                        <td class="text-center">
                            <span class="badge {% if row.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %} badge-sm">{{ row.prediction }}</span>
                        </td>
                        <td class="text-center">{{ row.correct }}/{{ row.total }}</td>
                        <td class="text-center {% if row.hit_rate > 55 %}text-success{% elif row.hit_rate < 45 %}text-danger{% endif %}"><strong>{{ row.hit_rate }}%</strong></td>
                        <td class="text-center">
                            {% if row.model_name in totals_weekly_ou %}
                            {{ totals_weekly_ou[row.model_name].hit_rate }}%
                            {% else %}<span class="text-muted">—</span>{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# ── Section 5: Recent Predictions ── #}
{% if recent_totals %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-journal-text"></i> Recent Totals Predictions
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Matchup</th>
                        <th class="text-center">Line</th>
                        <th class="text-center">Projection</th>
                        <th class="text-center">Pick</th>
                        <th class="text-center">Actual</th>
                        <th class="text-center">Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pred in recent_totals %}
                    <tr>
                        <td>{{ pred.away_name }} @ {{ pred.home_name }}</td>
                        <td class="text-center">{{ pred.over_under_line }}</td>
                        <td class="text-center">{{ pred.projected_total|round(1) }}</td>
                        <td class="text-center">
                            <span class="badge {% if pred.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ pred.prediction }}
                            </span>
                        </td>
                        <td class="text-center">{{ pred.actual_total }}</td>
                        <td class="text-center">
                            {% if pred.was_correct == 1 %}
                            <span class="badge bg-success">✓</span>
                            {% elif pred.was_correct == 0 %}
                            <span class="badge bg-danger">✗</span>
                            {% else %}
                            <span class="badge bg-secondary">PUSH</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if prediction_log %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-journal-text"></i> Recent Win Predictions
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matchup</th>
                        <th class="text-center">Prediction</th>
                        <th class="text-center">Actual</th>
                        <th class="text-center">Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pred in prediction_log[:20] %}
                    <tr>
                        <td><small>{{ pred.predicted_at[:10] if pred.predicted_at else '—' }}</small></td>
                        <td>
                            {{ pred.away_team_name or 'Away' }} @ {{ pred.home_team_name or 'Home' }}
                        </td>
                        <td class="text-center">
                            {% if pred.home_win_prob %}
                            {{ (pred.home_win_prob * 100)|round(1) }}% home
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if pred.status == 'final' %}
                            {{ pred.away_score or 0 }} - {{ pred.home_score or 0 }}
                            {% else %}
                            <span class="badge bg-secondary">{{ pred.status or 'pending' }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if pred.moneyline_correct == 1 %}
                            <span class="badge bg-success">✓</span>
                            {% elif pred.moneyline_correct == 0 %}
                            <span class="badge bg-danger">✗</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Page-specific JS placeholder
</script>
{% endblock %}
