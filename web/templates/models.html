{% extends "base.html" %}

{% block title %}Model Performance - College Baseball Predictor{% endblock %}

{% block content %}
<div class="mb-4 d-flex justify-content-between align-items-start">
    <div>
        <h1 class="h3">
            <i class="bi bi-gear"></i> Model Performance
        </h1>
        <p class="text-muted">Ensemble weights, accuracy tracking, and prediction history</p>
    </div>
    <a href="/models/trends" class="btn btn-outline-primary">
        <i class="bi bi-graph-up-arrow"></i> Accuracy Trends
    </a>
</div>

<div class="row">
    <!-- Weights Section -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-maroon">
                <i class="bi bi-pie-chart-fill"></i> Current Ensemble Weights
            </div>
            <div class="card-body">
                <canvas id="weightsChart" height="250"></canvas>
                
                <div class="table-responsive mt-4">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th class="text-center">Weight</th>
                                <th>Visual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in model_data %}
                            <tr>
                                <td>
                                    <strong>{{ model.name }}</strong>
                                </td>
                                <td class="text-center">{{ model.weight_pct|round(1) }}%</td>
                                <td style="width: 50%;">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ model.weight_pct }}%; background-color: var(--maroon);"
                                             aria-valuenow="{{ model.weight_pct }}" aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Accuracy Section -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> Model Accuracy
            </div>
            <div class="card-body">
                {% if model_data and model_data[0].accuracy %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th class="text-center">Recent</th>
                                <th class="text-center">All-Time</th>
                                <th class="text-center">Games</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for model in model_data %}
                            {% if model.accuracy %}
                            <tr>
                                <td>{{ model.name }}</td>
                                <td class="text-center">
                                    {% if model.accuracy.recent_accuracy %}
                                    <span class="{% if model.accuracy.recent_accuracy > 0.55 %}text-success{% elif model.accuracy.recent_accuracy < 0.45 %}text-danger{% endif %}">
                                        {{ (model.accuracy.recent_accuracy * 100)|round(1) }}%
                                    </span>
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if model.accuracy.all_time_accuracy %}
                                    {{ (model.accuracy.all_time_accuracy * 100)|round(1) }}%
                                    {% else %}
                                    <span class="text-muted">—</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{{ model.accuracy.all_time_predictions }}</span>
                                </td>
                            </tr>
                            {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2 text-muted">No accuracy data yet</p>
                    <small class="text-muted">Accuracy will be tracked once games are completed</small>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Model Descriptions -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-book"></i> Model Descriptions
            </div>
            <div class="card-body p-0">
                <div class="accordion accordion-flush" id="modelDescriptions">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-pythagorean">
                                Pythagorean
                            </button>
                        </h2>
                        <div id="desc-pythagorean" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Bill James' Pythagorean expectation — estimates true team strength from run production rather than win/loss record.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Total runs scored &amp; runs allowed</li>
                                    <li>Home/away run splits</li>
                                    <li>Pythagorean exponent (1.83 for college baseball)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-elo">
                                Elo
                            </button>
                        </h2>
                        <div id="desc-elo" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Chess-style rating system. Ratings update after each game based on result, margin, and opponent strength. Preseason ratings seeded from D1Baseball rankings + conference tiers.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Elo rating per team (updates after every game)</li>
                                    <li>Rating difference → win probability (logistic curve)</li>
                                    <li>K-factor: 32 (how fast ratings adjust)</li>
                                    <li>Home advantage: +50 Elo points</li>
                                    <li>League average runs/game (for run projections)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-log5">
                                Log5
                            </button>
                        </h2>
                        <div id="desc-log5" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Bill James' Log5 formula — calculates head-to-head win probability from each team's winning percentage, adjusting for the fact that both teams' records include games against varying opposition.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Overall win percentage</li>
                                    <li>Home/away win percentage splits</li>
                                    <li>Strength of schedule adjustment</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-advanced">
                                Advanced
                            </button>
                        </h2>
                        <div id="desc-advanced" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Game-results-based model with opponent adjustments and recency weighting. More recent games count more (exponential decay over last 15 games).</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Opponent-adjusted win % (weighted by opponent quality)</li>
                                    <li>Opponent-adjusted run differential per game</li>
                                    <li>Strength of schedule (opponent win %)</li>
                                    <li>Recency-weighted runs scored &amp; allowed</li>
                                    <li>Recent form (last 5 games)</li>
                                    <li>Rest days</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-pitching">
                                Pitching
                            </button>
                        </h2>
                        <div id="desc-pitching" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Staff quality model (v2). Uses team pitching quality tables and batting quality tables rather than trying to identify specific starters. Day-of-week blending accounts for rotation patterns.</p>
                                <strong>Pitching Inputs</strong> (from <code>team_pitching_quality</code>):
                                <ul>
                                    <li>Rotation ERA, WHIP, K/9 (top 3 starters by IP, IP-weighted)</li>
                                    <li>Bullpen ERA, WHIP, K/9 (non-starters)</li>
                                    <li>Ace quality: ERA, WHIP, K/9, FIP</li>
                                    <li>Staff depth: quality arms count, shutdown arms, innings HHI</li>
                                    <li>Fragility: rotation-bullpen ERA gap + innings concentration</li>
                                </ul>
                                <strong>Batting Inputs</strong> (from <code>team_batting_quality</code>):
                                <ul>
                                    <li>Lineup OPS, wOBA, wRC+ (top 9 by AB, AB-weighted)</li>
                                    <li>Lineup ISO, BABIP, K%, BB%</li>
                                    <li>Elite/solid/weak bat counts</li>
                                </ul>
                                <strong>Game Context:</strong>
                                <ul class="mb-0">
                                    <li>Day-of-week rotation blend (ace Fri 85%, bullpen Sun 45%)</li>
                                    <li>Home advantage: +3.5%</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-poisson">
                                Poisson
                            </button>
                        </h2>
                        <div id="desc-poisson" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Models runs as Poisson-distributed random variables. Builds a full probability matrix for every possible score, enabling precise over/under and run line calculations.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Home/away runs scored per game</li>
                                    <li>Home/away runs allowed per game</li>
                                    <li>League average runs (for regression)</li>
                                    <li>Batting quality adjustment (lineup wRC+)</li>
                                    <li>Pitching quality adjustment (staff ERA)</li>
                                    <li>Home advantage: +0.3 runs</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-conference">
                                Conference
                            </button>
                        </h2>
                        <div id="desc-conference" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Adjusts predictions based on conference strength tiers and cross-conference matchup patterns.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>Conference tier ratings (SEC, ACC, Big 12, etc.)</li>
                                    <li>Conference win % vs non-conference opponents</li>
                                    <li>Team conference standing</li>
                                    <li>Cross-conference matchup adjustments</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-prior">
                                Prior
                            </button>
                        </h2>
                        <div id="desc-prior" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Bayesian prior model — especially useful early in the season before enough games are played. Decays as real data accumulates.</p>
                                <strong>Inputs:</strong>
                                <ul class="mb-0">
                                    <li>D1Baseball preseason Top 25 rankings</li>
                                    <li>Historical program strength (last 3 seasons)</li>
                                    <li>Conference tier priors</li>
                                    <li>Preseason poll vote counts</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-neural">
                                Neural Network
                            </button>
                        </h2>
                        <div id="desc-neural" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Deep neural network (PyTorch) trained on 6,000+ historical games + 2026 season data. Two-phase training: base training on historical, then fine-tuned on recent games.</p>
                                <strong>81 Features per game (per team):</strong>
                                <ul>
                                    <li><em>Team Strength:</em> Elo, win %, last 10/20, run diff, Pythagorean %</li>
                                    <li><em>Batting:</em> AVG, OBP, SLG, OPS, HR/game, BB/game, SO/game, R/game</li>
                                    <li><em>Pitching:</em> ERA, WHIP, K/9, BB/9, HR/9, opp BA</li>
                                    <li><em>Advanced Batting:</em> wRC+, wOBA, ISO, BABIP, K%, BB%, GB/FB/LD%</li>
                                    <li><em>Advanced Pitching:</em> FIP, xFIP, SIERA, GB%, FB%</li>
                                    <li><em>Situational:</em> Days rest, strength of schedule</li>
                                    <li><em>Weather:</em> Temp, humidity, wind speed/direction, precip prob, dome flag</li>
                                    <li><em>Game Context:</em> Neutral site, conference game flag</li>
                                </ul>
                                <strong>Architecture:</strong> 81→128→64→32→1 (ReLU + dropout)
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-xgboost">
                                XGBoost
                            </button>
                        </h2>
                        <div id="desc-xgboost" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>GPU-accelerated gradient boosting (tree-based). Same 81 features as the neural network but uses decision tree ensembles instead of a neural architecture.</p>
                                <strong>Inputs:</strong> Same 81 features as Neural Network
                                <ul class="mb-0">
                                    <li>Team strength, batting, pitching, advanced stats, weather</li>
                                    <li>Trained on 6,184 historical games</li>
                                    <li>Feature normalization (z-score)</li>
                                    <li>Handles feature interactions natively via tree splits</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-lightgbm">
                                LightGBM
                            </button>
                        </h2>
                        <div id="desc-lightgbm" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Microsoft's gradient boosting framework using leaf-wise tree growth (vs XGBoost's level-wise). Often faster training with comparable accuracy.</p>
                                <strong>Inputs:</strong> Same 81 features as Neural Network
                                <ul class="mb-0">
                                    <li>Team strength, batting, pitching, advanced stats, weather</li>
                                    <li>Trained on 6,184 historical games</li>
                                    <li>Feature normalization (z-score)</li>
                                    <li>Also used for totals and spread prediction models</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#desc-ensemble">
                                Ensemble
                            </button>
                        </h2>
                        <div id="desc-ensemble" class="accordion-collapse collapse">
                            <div class="accordion-body small">
                                <p>Dynamic weighted combination of all models above. Weights auto-adjust based on recency-weighted accuracy — models that predict well recently get more influence.</p>
                                <strong>How it works:</strong>
                                <ul class="mb-0">
                                    <li>Win probability: weighted average of all model probabilities</li>
                                    <li>Run projections: from dedicated Runs Ensemble (Poisson 30%, Pitching 25%, Advanced 20%, Elo 15%, Pythagorean 10%)</li>
                                    <li>Weights update automatically with exponential decay (half-life ~30 predictions)</li>
                                    <li>Preseason models (Prior, Conference) decay as real data grows</li>
                                    <li>Minimum weight floor: 3% (no model fully drops out)</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Runs Ensemble Section -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header" style="background-color: #2563eb; color: white;">
                <i class="bi bi-graph-up"></i> Runs Ensemble (Totals Model)
            </div>
            <div class="card-body">
                <p class="text-muted small">Combines multiple models to predict game totals for over/under analysis</p>
                
                {% if runs_weights %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Model</th>
                                <th class="text-center">Weight</th>
                                <th>Visual</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for name, weight in runs_weights.items()|sort(attribute='1', reverse=true) %}
                            <tr>
                                <td><strong>{{ name }}</strong></td>
                                <td class="text-center">{{ (weight * 100)|round(0) }}%</td>
                                <td style="width: 50%;">
                                    <div class="progress" style="height: 16px;">
                                        <div class="progress-bar" role="progressbar" 
                                             style="width: {{ weight * 100 }}%; background-color: #2563eb;">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">Runs ensemble weights not available</p>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> Totals Prediction Accuracy
            </div>
            <div class="card-body">
                {% if totals_overall and totals_overall.total > 0 %}
                <div class="row mb-3">
                    <div class="col-4 text-center">
                        <h3 class="mb-0 {% if totals_overall.correct / (totals_overall.correct + totals_overall.incorrect) > 0.52 %}text-success{% else %}text-warning{% endif %}">
                            {{ ((totals_overall.correct / (totals_overall.correct + totals_overall.incorrect)) * 100)|round(1) }}%
                        </h3>
                        <small class="text-muted">Overall</small>
                    </div>
                    <div class="col-4 text-center">
                        <h3 class="mb-0">{{ totals_overall.correct }}</h3>
                        <small class="text-muted text-success">Correct</small>
                    </div>
                    <div class="col-4 text-center">
                        <h3 class="mb-0">{{ totals_overall.incorrect }}</h3>
                        <small class="text-muted text-danger">Wrong</small>
                    </div>
                </div>
                
                {% if totals_by_type %}
                <h6 class="mb-2">By Type:</h6>
                <div class="row mb-3">
                    {% for row in totals_by_type %}
                    <div class="col-6">
                        <span class="badge {% if row.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ row.prediction }}
                        </span>
                        {{ row.correct }}/{{ row.total }}
                        ({{ ((row.correct / row.total) * 100)|round(0) if row.total > 0 else 0 }}%)
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if totals_by_edge %}
                <h6 class="mb-2">By Edge:</h6>
                <table class="table table-sm">
                    <tbody>
                        {% for row in totals_by_edge %}
                        <tr>
                            <td>{{ row.edge_bucket }}</td>
                            <td class="text-center">{{ row.correct }}/{{ row.total }}</td>
                            <td class="text-end">
                                <span class="{% if row.total > 0 and row.correct / row.total > 0.55 %}text-success{% elif row.total > 0 and row.correct / row.total < 0.45 %}text-danger{% endif %}">
                                    {{ ((row.correct / row.total) * 100)|round(0) if row.total > 0 else 0 }}%
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% endif %}
                
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-graph-up display-4 text-muted"></i>
                    <p class="mt-2 text-muted">No totals predictions tracked yet</p>
                    <small class="text-muted">Run <code>track_totals.py predict</code> to start tracking</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if recent_totals %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-journal-text"></i> Recent Totals Predictions
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Matchup</th>
                        <th class="text-center">Line</th>
                        <th class="text-center">Projection</th>
                        <th class="text-center">Pick</th>
                        <th class="text-center">Actual</th>
                        <th class="text-center">Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pred in recent_totals %}
                    <tr>
                        <td>{{ pred.away_name }} @ {{ pred.home_name }}</td>
                        <td class="text-center">{{ pred.over_under_line }}</td>
                        <td class="text-center">{{ pred.projected_total|round(1) }}</td>
                        <td class="text-center">
                            <span class="badge {% if pred.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ pred.prediction }}
                            </span>
                        </td>
                        <td class="text-center">{{ pred.actual_total }}</td>
                        <td class="text-center">
                            {% if pred.was_correct == 1 %}
                            <span class="badge bg-success">✓</span>
                            {% elif pred.was_correct == 0 %}
                            <span class="badge bg-danger">✗</span>
                            {% else %}
                            <span class="badge bg-secondary">PUSH</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Prediction Log -->
{% if prediction_log %}
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-journal-text"></i> Recent Predictions
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matchup</th>
                        <th class="text-center">Prediction</th>
                        <th class="text-center">Actual</th>
                        <th class="text-center">Result</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pred in prediction_log[:20] %}
                    <tr>
                        <td><small>{{ pred.predicted_at[:10] if pred.predicted_at else '—' }}</small></td>
                        <td>
                            {{ pred.away_team_name or 'Away' }} @ {{ pred.home_team_name or 'Home' }}
                        </td>
                        <td class="text-center">
                            {% if pred.home_win_prob %}
                            {{ (pred.home_win_prob * 100)|round(1) }}% home
                            {% else %}
                            —
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if pred.status == 'final' %}
                            {{ pred.away_score or 0 }} - {{ pred.home_score or 0 }}
                            {% else %}
                            <span class="badge bg-secondary">{{ pred.status or 'pending' }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if pred.moneyline_correct == 1 %}
                            <span class="badge bg-success">✓</span>
                            {% elif pred.moneyline_correct == 0 %}
                            <span class="badge bg-danger">✗</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Weights pie chart
const ctx = document.getElementById('weightsChart').getContext('2d');

const colors = [
    '#5D1725', '#8B2942', '#B93B5E', '#E74C3C', '#F39C12', '#27AE60', '#3498DB'
];

new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: [{% for m in model_data %}'{{ m.name }}'{% if not loop.last %}, {% endif %}{% endfor %}],
        datasets: [{
            data: [{% for m in model_data %}{{ m.weight_pct|round(1) }}{% if not loop.last %}, {% endif %}{% endfor %}],
            backgroundColor: colors.slice(0, {{ model_data|length }}),
            borderWidth: 2,
            borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'right',
                labels: {
                    padding: 15,
                    usePointStyle: true
                }
            },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed.toFixed(1) + '%';
                    }
                }
            }
        }
    }
});
</script>
{% endblock %}
