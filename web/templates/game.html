{% extends "base.html" %}

{% block title %}{{ away.name }} @ {{ home.name }} - Game Detail{% endblock %}

{% block content %}
<div class="mb-3">
    <a href="javascript:history.back()" class="text-muted"><i class="bi bi-arrow-left"></i> Back</a>
</div>

<!-- Matchup Header -->
<div class="card">
    <div class="card-header bg-maroon text-center">
        <div class="d-flex justify-content-center align-items-center gap-3">
            <div class="d-flex align-items-center">
                <img src="{{ team_logo(away.id) }}" height="48" class="me-2" onerror="this.style.display='none'">
                <span class="fs-5">
                    {% if away.rank %}<small class="text-white-50">#{{ away.rank }}</small> {% endif %}{{ away.name }}
                </span>
            </div>
            <span class="text-white-50">@</span>
            <div class="d-flex align-items-center">
                <img src="{{ team_logo(home.id) }}" height="48" class="me-2" onerror="this.style.display='none'">
                <span class="fs-5">
                    {% if home.rank %}<small class="text-white-50">#{{ home.rank }}</small> {% endif %}{{ home.name }}
                </span>
            </div>
        </div>
        <small class="text-white-50">{{ game.date }} {{ game.time or '' }} {% if game.venue %}‚Ä¢ {{ game.venue }}{% endif %}</small>
        {% if gqi %}
        <div class="mt-1">
            <span class="badge" style="background-color:{{ gqi_color }};font-size:.75rem">GQI {{ gqi }} &mdash; {{ gqi_label }}</span>
        </div>
        {% endif %}
    </div>
    <div class="card-body">
        {% if game.status == 'final' or game.status == 'in-progress' %}
        <div class="row text-center">
            <div class="col-5">
                <div class="display-4 {% if game.away_score and game.home_score and game.away_score > game.home_score %}fw-bold{% else %}text-muted{% endif %}">{{ game.away_score or 0 }}</div>
                <div class="text-muted">{{ away.record }}</div>
            </div>
            <div class="col-2 d-flex align-items-center justify-content-center">
                <div>
                    {% if game.status == 'final' %}
                    <span class="badge bg-success">Final</span>
                    {% if game.innings and game.innings != 9 %}<br><small class="text-muted">({{ game.innings }})</small>{% endif %}
                    {% else %}
                    <span class="badge bg-warning text-dark">{{ game.inning_text or 'Live' }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-5">
                <div class="display-4 {% if game.home_score and game.away_score and game.home_score > game.away_score %}fw-bold{% else %}text-muted{% endif %}">{{ game.home_score or 0 }}</div>
                <div class="text-muted">{{ home.record }}</div>
            </div>
        </div>

        <!-- Linescore + R/H/E -->
        {% if game.linescore or game.home_hits is not none %}
        <div class="mt-3">
            <div class="table-responsive">
                <table class="table table-sm table-dark text-center mb-0" style="font-size:0.85rem;">
                    <thead>
                        <tr>
                            <th class="text-start" style="min-width:120px;"></th>
                            {% if game.linescore %}
                            {% for i in range(game.linescore.away|length) %}
                            <th style="width:28px;">{{ i + 1 }}</th>
                            {% endfor %}
                            {% endif %}
                            <th class="border-start" style="width:32px;">R</th>
                            <th style="width:32px;">H</th>
                            <th style="width:32px;">E</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="text-start fw-bold">{{ away.name }}</td>
                            {% if game.linescore %}
                            {% for r in game.linescore.away %}
                            <td>{{ r }}</td>
                            {% endfor %}
                            {% endif %}
                            <td class="border-start fw-bold">{{ game.away_score or 0 }}</td>
                            <td>{{ game.away_hits if game.away_hits is not none else '-' }}</td>
                            <td>{{ game.away_errors if game.away_errors is not none else '-' }}</td>
                        </tr>
                        <tr>
                            <td class="text-start fw-bold">{{ home.name }}</td>
                            {% if game.linescore %}
                            {% for r in game.linescore.home %}
                            <td>{{ r }}</td>
                            {% endfor %}
                            {% endif %}
                            <td class="border-start fw-bold">{{ game.home_score or 0 }}</td>
                            <td>{{ game.home_hits if game.home_hits is not none else '-' }}</td>
                            <td>{{ game.home_errors if game.home_errors is not none else '-' }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Live situation -->
        {% if game.situation and game.status == 'in-progress' %}
        {% set sit = game.situation %}
        {% set s_outs = sit.sb_outs if sit.sb_outs is defined and sit.sb_outs is not none else sit.outs %}
        {% set s_balls = sit.sb_balls if sit.sb_balls is defined and sit.sb_balls is not none else sit.balls %}
        {% set s_strikes = sit.sb_strikes if sit.sb_strikes is defined and sit.sb_strikes is not none else sit.strikes %}
        {% set s_pitcher = sit.sb_pitcher or sit.pitcher %}
        {% set s_batter = sit.sb_batter or sit.batter %}
        {% set on_1b = sit.sb_on_first if sit.sb_on_first is defined and sit.sb_on_first is not none else sit.onFirst %}
        {% set on_2b = sit.sb_on_second if sit.sb_on_second is defined and sit.sb_on_second is not none else sit.onSecond %}
        {% set on_3b = sit.sb_on_third if sit.sb_on_third is defined and sit.sb_on_third is not none else sit.onThird %}
        <div class="mt-3 p-3 rounded" style="background:rgba(255,255,255,0.05);">
            <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-3">
                    <!-- Base diamond -->
                    <svg width="48" height="48" viewBox="0 0 40 40" style="flex-shrink:0;">
                        <rect x="13" y="3" width="14" height="14" rx="1" transform="rotate(45 20 10)" 
                              fill="{{ '#fbbf24' if on_2b else '#374151' }}" stroke="#6b7280" stroke-width="1.5"/>
                        <rect x="23" y="13" width="14" height="14" rx="1" transform="rotate(45 30 20)" 
                              fill="{{ '#fbbf24' if on_1b else '#374151' }}" stroke="#6b7280" stroke-width="1.5"/>
                        <rect x="3" y="13" width="14" height="14" rx="1" transform="rotate(45 10 20)" 
                              fill="{{ '#fbbf24' if on_3b else '#374151' }}" stroke="#6b7280" stroke-width="1.5"/>
                    </svg>
                    <!-- Outs + Count -->
                    <div>
                        <div>
                            {% for i in range(3) %}
                            <span style="color:{{ '#fbbf24' if i < s_outs else '#374151' }};font-size:1.1rem;">‚óè</span>
                            {% endfor %}
                            <span class="text-muted ms-1">{{ s_outs }} out{{ 's' if s_outs != 1 }}</span>
                        </div>
                        {% if s_balls is not none %}
                        <div class="text-muted" style="font-size:0.85rem;">Count: {{ s_balls }}-{{ s_strikes }}</div>
                        {% endif %}
                    </div>
                </div>
                <!-- Pitcher / Batter -->
                <div class="text-end">
                    {% if s_pitcher %}
                    <div><small class="text-muted">Pitching:</small> <span class="fw-bold">{{ s_pitcher }}</span></div>
                    {% endif %}
                    {% if s_batter %}
                    <div><small class="text-muted">At Bat:</small> <span class="fw-bold">{{ s_batter }}{% if sit.sb_batter_position %} [{{ sit.sb_batter_position }}]{% endif %}</span></div>
                    {% endif %}
                    {% if sit.lastPlay %}
                    <div class="mt-1"><small class="text-muted fst-italic">{{ sit.lastPlay }}</small></div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Previously This Inning -->
        {% if sit.sb_plays is defined and sit.sb_plays %}
        {% set current_half = sit.sb_plays[-1] if sit.sb_plays else none %}
        {% if current_half and current_half.plays %}
        <div class="mt-3 p-3 rounded" style="background:rgba(255,255,255,0.05);">
            <h6 class="text-muted mb-2" style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">
                ‚öæ Previously This Inning
                <span class="ms-2 fw-normal" style="text-transform:none; letter-spacing:0;">{{ current_half.label }}</span>
            </h6>
            <div class="ps-2" style="border-left: 2px solid #374151;">
                {% for play in current_half.plays|reverse %}
                <div class="mb-1 d-flex align-items-start gap-2" style="font-size:0.85rem;">
                    {% if play.is_scoring %}
                    <span class="badge bg-success" style="font-size:0.65rem; min-width:18px;">R</span>
                    {% elif play.bases %}
                    <span class="badge" style="background:#2563eb; font-size:0.65rem; min-width:18px;">{{ play.bases }}</span>
                    {% else %}
                    <span class="text-muted" style="font-size:0.65rem; min-width:18px;">‚äò</span>
                    {% endif %}
                    <span{% if play.is_scoring %} class="text-success fw-bold"{% endif %}>{{ play.text }}</span>
                </div>
                {% endfor %}
            </div>
            {% if current_half.summary %}
            <div class="mt-2 text-muted" style="font-size:0.75rem; font-style:italic;">
                {{ current_half.summary }}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}

        <!-- All Scoring Plays -->
        {% if sit.sb_scoring_plays is defined and sit.sb_scoring_plays %}
        <div class="mt-3 p-3 rounded" style="background:rgba(255,255,255,0.05);">
            <h6 class="text-muted mb-2" style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px;">
                üìã Scoring Plays
            </h6>
            <div style="max-height: 350px; overflow-y: auto;">
                {% for play in sit.sb_scoring_plays|reverse %}
                <div class="mb-2 d-flex align-items-start gap-2" style="font-size:0.85rem;">
                    <div style="min-width: 52px; flex-shrink:0;">
                        <span class="badge bg-success" style="font-size:0.65rem;">{{ play.inning }}</span>
                    </div>
                    <div>
                        <span class="fw-bold" style="color:#fbbf24;">{{ play.team }}</span>
                        <span class="text-muted mx-1">‚Äî</span>
                        <span>{{ play.text }}</span>
                        {% if play.scoring %}
                        <span class="text-muted ms-1" style="font-size:0.7rem;">({{ play.scoring }})</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% endif %}

        {% elif game.status != 'final' and game.status != 'in-progress' %}
        <div class="row text-center">
            <div class="col-5">
                <div class="h4">{{ away.record }}</div>
                <div class="text-muted">Elo: {{ away.elo|round(0)|int }}</div>
            </div>
            <div class="col-2 d-flex align-items-center justify-content-center">
                <span class="text-muted">vs</span>
            </div>
            <div class="col-5">
                <div class="h4">{{ home.record }}</div>
                <div class="text-muted">Elo: {{ home.elo|round(0)|int }}</div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

{% if prediction %}
<!-- Prediction -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-star-fill"></i> Meta-Ensemble Prediction
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-5">
                <div class="h2 {% if prediction.away_win_prob > 0.5 %}text-success{% else %}text-muted{% endif %}">{{ (prediction.away_win_prob * 100)|round(1) }}%</div>
                <div class="text-muted">{{ (prediction.projected_away_runs|round(1) ~ ' runs') if prediction.projected_away_runs is not none else '‚Äî' }}</div>
            </div>
            <div class="col-2 d-flex align-items-center justify-content-center flex-column">
                <small class="text-muted">Total</small>
                <div class="fw-bold">{{ prediction.projected_total|round(1) if prediction.projected_total is not none else '‚Äî' }}</div>
            </div>
            <div class="col-5">
                <div class="h2 {% if prediction.home_win_prob > 0.5 %}text-success{% else %}text-muted{% endif %}">{{ (prediction.home_win_prob * 100)|round(1) }}%</div>
                <div class="text-muted">{{ (prediction.projected_home_runs|round(1) ~ ' runs') if prediction.projected_home_runs is not none else '‚Äî' }}</div>
            </div>
        </div>
    </div>
</div>

{% if series_probs %}
<!-- Series Outlook -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-collection"></i> 3-Game Series Outlook
    </div>
    <div class="card-body">
        <div class="row text-center mb-2">
            <div class="col-4"><small class="text-muted"></small></div>
            <div class="col-4"><small class="fw-bold">{{ away.name }}</small></div>
            <div class="col-4"><small class="fw-bold">{{ home.name }}</small></div>
        </div>
        <div class="row text-center align-items-center mb-2">
            <div class="col-4 text-start"><small class="text-muted">Win 1+ game</small></div>
            <div class="col-4"><span class="{% if series_probs.away_win_1plus > series_probs.home_win_1plus %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.away_win_1plus * 100)|round(1) }}%</span></div>
            <div class="col-4"><span class="{% if series_probs.home_win_1plus > series_probs.away_win_1plus %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.home_win_1plus * 100)|round(1) }}%</span></div>
        </div>
        <div class="row text-center align-items-center mb-2">
            <div class="col-4 text-start"><small class="text-muted">Win series (2+)</small></div>
            <div class="col-4"><span class="{% if series_probs.away_win_2plus > series_probs.home_win_2plus %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.away_win_2plus * 100)|round(1) }}%</span></div>
            <div class="col-4"><span class="{% if series_probs.home_win_2plus > series_probs.away_win_2plus %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.home_win_2plus * 100)|round(1) }}%</span></div>
        </div>
        <div class="row text-center align-items-center">
            <div class="col-4 text-start"><small class="text-muted">Sweep</small></div>
            <div class="col-4"><span class="{% if series_probs.away_sweep > series_probs.home_sweep %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.away_sweep * 100)|round(1) }}%</span></div>
            <div class="col-4"><span class="{% if series_probs.home_sweep > series_probs.away_sweep %}fw-bold text-success{% else %}text-muted{% endif %}">{{ (series_probs.home_sweep * 100)|round(1) }}%</span></div>
        </div>
    </div>
</div>
{% endif %}

<!-- All Models -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-list-check"></i> Model Breakdown
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr><th>Model</th><th class="text-center">{{ away.name }}</th><th class="text-center">{{ home.name }}</th><th class="text-center">Runs</th><th class="text-center">Pick</th></tr>
                </thead>
                <tbody>
                {% for m in models %}
                {% if m.name != 'ensemble' %}
                <tr {% if m.name == 'meta_ensemble' %}class="table-active fw-bold"{% endif %}>
                    <td>{% if m.name == 'meta_ensemble' %}‚òÖ {% endif %}{{ m.name }}</td>
                    <td class="text-center">{{ (m.away_prob * 100)|round(1) }}%</td>
                    <td class="text-center">{{ (m.home_prob * 100)|round(1) }}%</td>
                    <td class="text-center">{% if m.away_runs is not none and m.home_runs is not none %}{{ m.away_runs|round(1) }}-{{ m.home_runs|round(1) }}{% else %}‚Äî{% endif %}</td>
                    <td class="text-center">{{ home.name if m.home_prob > 0.5 else away.name }}</td>
                </tr>
                {% endif %}
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if totals_models %}
<!-- Runs Model Breakdown -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-bar-chart"></i> Runs Model Breakdown
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0">
                <thead>
                    <tr>
                        <th>Model</th>
                        <th class="text-center">Line</th>
                        <th class="text-center">Projected</th>
                        <th class="text-center">Pick</th>
                        {% if totals_models[0].actual_total is not none %}
                        <th class="text-center">Actual</th>
                        <th class="text-center">Result</th>
                        {% endif %}
                    </tr>
                </thead>
                <tbody>
                {% for m in totals_models %}
                <tr {% if m.model_name == 'runs_ensemble' %}class="table-active fw-bold"{% endif %}>
                    <td>{% if m.model_name == 'runs_ensemble' %}‚òÖ {% endif %}{{ m.model_name }}</td>
                    <td class="text-center">{{ m.over_under_line if m.over_under_line else '‚Äî' }}</td>
                    <td class="text-center">{{ m.projected_total|round(1) }}</td>
                    <td class="text-center">
                        {% if m.prediction %}
                        <span class="badge {% if m.prediction == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ m.prediction }}
                        </span>
                        {% else %}
                        ‚Äî
                        {% endif %}
                    </td>
                    {% if totals_models[0].actual_total is not none %}
                    <td class="text-center">{{ m.actual_total }}</td>
                    <td class="text-center">
                        {% if m.was_correct == 1 %}
                        <span class="badge bg-success">‚úì</span>
                        {% elif m.was_correct == 0 %}
                        <span class="badge bg-danger">‚úó</span>
                        {% else %}
                        <span class="badge bg-secondary">PUSH</span>
                        {% endif %}
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

{% if betting_line %}
<!-- DraftKings Lines -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-currency-dollar"></i> DraftKings Lines
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-4">
                <small class="text-muted">{{ away.name }} ML</small>
                <div class="h5">{{ betting_line.away_ml|format_odds }}</div>
            </div>
            <div class="col-4">
                <small class="text-muted">Total</small>
                <div class="h5">{{ betting_line.over_under or '‚Äî' }}</div>
            </div>
            <div class="col-4">
                <small class="text-muted">{{ home.name }} ML</small>
                <div class="h5">{{ betting_line.home_ml|format_odds }}</div>
            </div>
        </div>
        {% if prediction and betting_line.home_edge %}
        <hr>
        <div class="row text-center">
            <div class="col-6">
                <small class="text-muted">{{ away.name }} Edge</small>
                <div class="h5 {% if betting_line.away_edge > 5 %}text-success{% elif betting_line.away_edge < -5 %}text-danger{% endif %}">
                    {{ '%+.1f'|format(betting_line.away_edge) }}%
                </div>
            </div>
            <div class="col-6">
                <small class="text-muted">{{ home.name }} Edge</small>
                <div class="h5 {% if betting_line.home_edge > 5 %}text-success{% elif betting_line.home_edge < -5 %}text-danger{% endif %}">
                    {{ '%+.1f'|format(betting_line.home_edge) }}%
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if resume_impact %}
<!-- Resume Impact -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-trophy"></i> Resume Impact
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Away team -->
            <div class="col-6">
                <div class="text-center mb-2">
                    <strong>{{ away.name }}</strong>
                    <div class="text-muted" style="font-size:.8rem">Elo Rank: #{{ resume_impact.away.elo_rank }}</div>
                </div>
                <div class="text-center mb-3">
                    <span class="badge fs-6 px-3 py-2" style="background-color:{{ resume_impact.away.quadrant|replace('Q1','#1a7431')|replace('Q2','#2196F3')|replace('Q3','#FF9800')|replace('Q4','#d32f2f') }}">
                        {{ resume_impact.away.quadrant }} Game
                    </span>
                </div>
                <!-- Win Quality -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Win Quality</small>
                        <small style="color:{{ resume_impact.away.win_color }}">{{ resume_impact.away.win_label }}</small>
                    </div>
                    <div class="progress" style="height:8px">
                        <div class="progress-bar" style="width:{{ [(resume_impact.away.win_quality + 0.5) / 1.5 * 100, 0]|max }}%;background-color:{{ resume_impact.away.win_color }}"></div>
                    </div>
                    <div class="text-end"><small class="text-muted">{{ '%+.2f'|format(resume_impact.away.win_quality) }}</small></div>
                </div>
                <!-- Loss Damage -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Loss Damage</small>
                        <small style="color:{{ resume_impact.away.loss_color }}">{{ resume_impact.away.loss_label }}</small>
                    </div>
                    <div class="progress" style="height:8px">
                        <div class="progress-bar" style="width:{{ [(resume_impact.away.loss_damage + 1.0) / 1.5 * 100, 0]|max }}%;background-color:{{ resume_impact.away.loss_color }}"></div>
                    </div>
                    <div class="text-end"><small class="text-muted">{{ '%+.2f'|format(resume_impact.away.loss_damage) }}</small></div>
                </div>
                <!-- Quadrant Record -->
                <div>
                    <small class="text-muted d-block mb-1">Quadrant Record</small>
                    {% for q in ['Q1','Q2','Q3','Q4'] %}
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge me-2" style="background-color:{{'#1a7431' if q=='Q1' else '#2196F3' if q=='Q2' else '#FF9800' if q=='Q3' else '#d32f2f'}};min-width:28px;font-size:.7rem">{{ q }}</span>
                        <small>{{ resume_impact.away.quad_record[q] }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- Home team -->
            <div class="col-6">
                <div class="text-center mb-2">
                    <strong>{{ home.name }}</strong>
                    <div class="text-muted" style="font-size:.8rem">Elo Rank: #{{ resume_impact.home.elo_rank }}</div>
                </div>
                <div class="text-center mb-3">
                    <span class="badge fs-6 px-3 py-2" style="background-color:{{ resume_impact.home.quadrant|replace('Q1','#1a7431')|replace('Q2','#2196F3')|replace('Q3','#FF9800')|replace('Q4','#d32f2f') }}">
                        {{ resume_impact.home.quadrant }} Game
                    </span>
                </div>
                <!-- Win Quality -->
                <div class="mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Win Quality</small>
                        <small style="color:{{ resume_impact.home.win_color }}">{{ resume_impact.home.win_label }}</small>
                    </div>
                    <div class="progress" style="height:8px">
                        <div class="progress-bar" style="width:{{ [(resume_impact.home.win_quality + 0.5) / 1.5 * 100, 0]|max }}%;background-color:{{ resume_impact.home.win_color }}"></div>
                    </div>
                    <div class="text-end"><small class="text-muted">{{ '%+.2f'|format(resume_impact.home.win_quality) }}</small></div>
                </div>
                <!-- Loss Damage -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <small class="text-muted">Loss Damage</small>
                        <small style="color:{{ resume_impact.home.loss_color }}">{{ resume_impact.home.loss_label }}</small>
                    </div>
                    <div class="progress" style="height:8px">
                        <div class="progress-bar" style="width:{{ [(resume_impact.home.loss_damage + 1.0) / 1.5 * 100, 0]|max }}%;background-color:{{ resume_impact.home.loss_color }}"></div>
                    </div>
                    <div class="text-end"><small class="text-muted">{{ '%+.2f'|format(resume_impact.home.loss_damage) }}</small></div>
                </div>
                <!-- Quadrant Record -->
                <div>
                    <small class="text-muted d-block mb-1">Quadrant Record</small>
                    {% for q in ['Q1','Q2','Q3','Q4'] %}
                    <div class="d-flex align-items-center mb-1">
                        <span class="badge me-2" style="background-color:{{'#1a7431' if q=='Q1' else '#2196F3' if q=='Q2' else '#FF9800' if q=='Q3' else '#d32f2f'}};min-width:28px;font-size:.7rem">{{ q }}</span>
                        <small>{{ resume_impact.home.quad_record[q] }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if cross_matchup %}
<!-- Matchup Breakdown -->
{% macro stat_value(s) %}{% if s.name in ['K%', 'BB%'] %}{{ '%.1f'|format(s.value) }}%{% elif s.name in ['RPG', 'HR/G', 'ERA', 'WHIP', 'FIP', 'K/9', 'BB/9'] %}{{ '%.2f'|format(s.value) }}{% else %}{{ '%.3f'|format(s.value) }}{% endif %}{% endmacro %}
{% macro matchup_panel(title, offense_stats, pitching_stats) %}
<div class="col-lg-6 mb-3 mb-lg-0">
    <h6 class="text-center mb-2">{{ title }}</h6>
    <div class="table-responsive">
        <table class="table table-sm mb-2">
            <thead><tr><th colspan="3" class="text-muted" style="font-size:.75rem">Offense</th></tr></thead>
            <tbody>
            {% for s in offense_stats %}
            <tr>
                <td style="width:40%">{{ s.name }}</td>
                <td class="text-center" style="width:30%">{{ stat_value(s) }}</td>
                <td class="text-center" style="width:30%">
                    <span class="badge" style="background-color:{{ s.color }};color:#fff;min-width:32px">{{ s.percentile }}</span>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        <table class="table table-sm mb-0">
            <thead><tr><th colspan="3" class="text-muted" style="font-size:.75rem">Pitching</th></tr></thead>
            <tbody>
            {% for s in pitching_stats %}
            <tr>
                <td style="width:40%">{{ s.name }}</td>
                <td class="text-center" style="width:30%">{{ stat_value(s) }}</td>
                <td class="text-center" style="width:30%">
                    <span class="badge" style="background-color:{{ s.color }};color:#fff;min-width:32px">{{ s.percentile }}</span>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endmacro %}
<div class="card">
    <div class="card-header">
        <i class="bi bi-arrow-left-right"></i> Matchup Breakdown
    </div>
    <div class="card-body">
        <div class="row">
            {{ matchup_panel(away.name ~ ' Offense vs ' ~ home.name ~ ' Pitching', cross_matchup.away_offense, cross_matchup.home_pitching) }}
            {{ matchup_panel(home.name ~ ' Offense vs ' ~ away.name ~ ' Pitching', cross_matchup.home_offense, cross_matchup.away_pitching) }}
        </div>
    </div>
</div>
{% endif %}

{% if h2h_games %}
<!-- Head-to-Head History -->
<div class="card">
    <div class="card-header">
        <i class="bi bi-clock-history"></i> Head-to-Head History
        <span class="badge bg-secondary ms-2">{{ h2h_record.away_wins }}-{{ h2h_record.home_wins }}</span>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm mb-0">
                <thead><tr><th>Date</th><th class="text-center">Score</th><th>Winner</th></tr></thead>
                <tbody>
                {% for g in h2h_games %}
                <tr>
                    <td>{{ g.date }}</td>
                    <td class="text-center">{{ g.away_score }}-{{ g.home_score }}</td>
                    <td>
                        {% if g.winner == 'home' %}
                        <strong>{{ home.name }}</strong>
                        {% elif g.winner == 'away' %}
                        <strong>{{ away.name }}</strong>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<div class="text-center mt-3">
    <a href="/predict?home={{ home.id }}&away={{ away.id }}" class="btn btn-maroon">
        <i class="bi bi-calculator"></i> Full Prediction Tool
    </a>
    <a href="/team/{{ home.id }}" class="btn btn-outline-secondary">{{ home.name }}</a>
    <a href="/team/{{ away.id }}" class="btn btn-outline-secondary">{{ away.name }}</a>
</div>
{% endblock %}
