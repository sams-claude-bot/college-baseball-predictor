{% extends "base.html" %}

{% block title %}Betting Analysis - College Baseball Predictor{% endblock %}

{# Macro for visual model agreement meter #}
{% macro agreement_meter(count, total, size='md') %}
{% set pct = (count / total * 100) if total > 0 else 0 %}
{% set color = 'success' if count >= 9 else ('primary' if count >= 7 else ('warning' if count >= 5 else 'secondary')) %}
<div class="agreement-meter agreement-meter-{{ size }}" title="{{ count }}/{{ total }} models agree">
    <div class="meter-dots">
        {% for i in range(total) %}
        <span class="dot {% if i < count %}filled bg-{{ color }}{% endif %}"></span>
        {% endfor %}
    </div>
    <div class="meter-label {% if count >= 9 %}text-success{% elif count >= 7 %}text-primary{% elif count >= 5 %}text-warning{% else %}text-muted{% endif %}">
        {{ count }}/{{ total }}
    </div>
</div>
{% endmacro %}

{% block content %}
<style>
.agreement-meter {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}
.agreement-meter .meter-dots {
    display: inline-flex;
    align-items: center;
    gap: 3px;
}
.agreement-meter .dot {
    width: 7px;
    height: 7px;
    border-radius: 50%;
    background: #e9ecef;
    flex-shrink: 0;
}
.agreement-meter .dot.filled {
    box-shadow: 0 0 2px rgba(0,0,0,0.2);
}
.agreement-meter .meter-label {
    font-weight: 700;
    font-size: 0.8rem;
    min-width: 32px;
}
.agreement-meter-sm .meter-dots {
    gap: 2px;
}
.agreement-meter-sm .dot {
    width: 5px;
    height: 5px;
}
.agreement-meter-sm .meter-label {
    font-size: 0.7rem;
    min-width: 28px;
}
.agreement-meter-lg .dot {
    width: 9px;
    height: 9px;
}
.agreement-meter-lg .meter-dots {
    gap: 4px;
}
.agreement-meter-lg .meter-label {
    font-size: 0.9rem;
}
/* Subtle glow for high agreement */
.agreement-meter .dot.filled.bg-success {
    box-shadow: 0 0 4px rgba(25, 135, 84, 0.5);
}
</style>
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-currency-dollar"></i> Betting Analysis</h1>
        <p class="text-muted mb-0">Compare model predictions to DraftKings &amp; FanDuel lines and find value</p>
    </div>
    <div class="filter-bar">
        <select class="form-select"
                onchange="window.location.href='/betting?conference=' + encodeURIComponent(this.value)">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Model Agreement Legend -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <strong class="me-2"><i class="bi bi-info-circle"></i> Model Signals:</strong>
            <span><span class="badge bg-primary">X/12</span> Number of models agreeing on pick</span>
            <span><span class="badge bg-success">AGREE</span> Both NN &amp; Ensemble agree with &gt;60% confidence</span>
            <span><span class="badge bg-danger">SPLIT</span> Models disagree on the winner</span>
            <span><span class="badge bg-success">Heavy Favorite</span> Pick-side model probability ‚â• 70%</span>
            <span><span class="badge bg-primary">Moderate Edge</span> Pick-side model probability 60-69%</span>
            <span><span class="badge bg-secondary">Coin Flip</span> Pick-side model probability &lt; 60%</span>
        </div>
    </div>
</div>

<!-- 4-Leg Parlay -->
{% if parlay_legs and parlay_legs|length == 4 %}
<div class="card mb-4">
    <div class="card-header" style="background: linear-gradient(135deg, #7c3aed, #a855f7); color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-trophy-fill"></i> 4-Leg Parlay of the Day</span>
            <div>
                <span class="badge bg-light text-dark">+{{ parlay_american }}</span>
                <span class="badge bg-light text-dark">${{ parlay_payout }} on $10</span>
                <span class="badge bg-light text-dark">{{ parlay_prob }}% raw</span>
                {% if parlay_calibrated_prob %}
                <span class="badge bg-warning text-dark" title="Calibrated probability ‚Äî adjusted for model overconfidence">{{ parlay_calibrated_prob }}% cal</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for leg in parlay_legs %}
            <div class="col-md-3 mb-3">
                <div class="card h-100 {% if leg.type == 'ML' %}border-primary{% else %}border-info{% endif %}" 
                     style="cursor:pointer" onclick="window.location='/game/{{ leg.game_id }}'">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <span class="badge {% if leg.type == 'ML' %}bg-primary{% else %}bg-info{% endif %}">{{ leg.type }}</span>
                            {% if leg.leg_result == 'won' %}
                            <span class="badge bg-success">‚úì Won</span>
                            {% elif leg.leg_result == 'lost' %}
                            <span class="badge bg-danger">‚úó Lost</span>
                            {% elif leg.leg_result == 'live' %}
                            <span class="badge bg-warning text-dark"><i class="bi bi-broadcast"></i> Live</span>
                            {% else %}
                            <span class="badge bg-dark">Leg {{ loop.index }}</span>
                            {% endif %}
                        </div>
                        <h6 class="mb-1 fw-bold">{{ leg.pick_label }}</h6>
                        <small class="text-muted d-block mb-2">{{ leg.matchup }}</small>
                        {% if leg.game_status in ['in-progress', 'final'] %}
                        <div class="d-flex justify-content-between align-items-center mb-2 py-1 px-2 rounded" 
                             style="background: {% if leg.leg_result == 'won' %}rgba(16,185,129,0.1){% elif leg.leg_result == 'lost' %}rgba(239,68,68,0.1){% else %}rgba(251,191,36,0.1){% endif %};">
                            <span class="fw-bold" style="font-size: 0.95rem;">{{ leg.away_score }} - {{ leg.home_score }}</span>
                            <small class="{% if leg.game_status == 'final' %}text-muted{% else %}text-warning{% endif %}">{{ leg.inning_text }}</small>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">{{ leg.odds|format_odds }}</span>
                            <span class="text-success small">{{ (leg.prob * 100)|round(0) }}% conf</span>
                        </div>
                        <div class="mt-1">
                            <small class="text-muted">+{{ leg.edge|round(1) }}% edge</small>
                            {% if leg.calibrated_edge is defined and leg.calibrated_edge is not none %}
                            <span class="badge bg-{{ 'success' if leg.calibrated_edge > 5 else 'warning text-dark' if leg.calibrated_edge > 0 else 'danger' }}" style="font-size: 0.65rem;" title="Calibrated edge">{{ leg.calibrated_edge|round(1) }}% cal</span>
                            {% endif %}
                            {% if leg.models_agree and leg.models_agree >= 7 %}
                            <span class="badge bg-secondary ms-1" style="font-size: 0.65rem;">{{ leg.models_agree }}/12</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        <div class="d-flex justify-content-between align-items-center mt-2">
            <small class="text-muted">
                <i class="bi bi-info-circle"></i> 
                Mix of ML &amp; totals picks in the sweet spot: ~75-85% confidence, moderate lines, strong edge. No -300+ chalk.
            </small>
            <button class="btn btn-sm btn-outline-light" onclick="shareParlay()" style="border-color: #a855f7; color: #7c3aed;">
                <i class="bi bi-share-fill"></i> Share Card
            </button>
        </div>
    </div>
</div>

<!-- Hidden shareable parlay card -->
<div id="parlayShareCard" style="position:absolute;left:-9999px;top:0;">
    <div style="width:600px;padding:32px;background:linear-gradient(135deg,#1a1a2e,#16213e,#0f3460);border-radius:16px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:white;">
        <div style="text-align:center;margin-bottom:20px;">
            <div style="font-size:14px;text-transform:uppercase;letter-spacing:2px;color:#a855f7;margin-bottom:4px;">‚öæ College Baseball Predictor</div>
            <div style="font-size:28px;font-weight:800;background:linear-gradient(135deg,#7c3aed,#a855f7);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">4-Leg Parlay of the Day</div>
            <div style="font-size:13px;color:#94a3b8;margin-top:4px;">{{ parlay_legs[0].game_id[:10] if parlay_legs else '' }}</div>
        </div>
        {% for leg in parlay_legs %}
        <div style="background:rgba(255,255,255,0.08);border-radius:12px;padding:14px 18px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;border-left:4px solid {% if leg.type == 'ML' %}#7c3aed{% else %}#06b6d4{% endif %};">
            <div>
                <div style="font-size:11px;color:{% if leg.type == 'ML' %}#a855f7{% else %}#22d3ee{% endif %};text-transform:uppercase;letter-spacing:1px;margin-bottom:2px;">Leg {{ loop.index }} ‚Ä¢ {{ leg.type }}</div>
                <div style="font-size:18px;font-weight:700;">{{ leg.pick_label }}</div>
                <div style="font-size:12px;color:#94a3b8;">{{ leg.matchup }}</div>
            </div>
            <div style="text-align:right;">
                <div style="font-size:20px;font-weight:800;color:{% if leg.odds > 0 %}#4ade80{% else %}white{% endif %};">{{ '%+d'|format(leg.odds) }}</div>
                <div style="font-size:11px;color:#94a3b8;">{{ (leg.prob * 100)|round(0) }}% conf</div>
            </div>
        </div>
        {% endfor %}
        <div style="margin-top:18px;display:flex;justify-content:space-around;text-align:center;background:rgba(124,58,237,0.2);border-radius:12px;padding:14px;">
            <div>
                <div style="font-size:24px;font-weight:800;color:#a855f7;">+{{ parlay_american }}</div>
                <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;">Parlay Odds</div>
            </div>
            <div style="border-left:1px solid rgba(255,255,255,0.1);"></div>
            <div>
                <div style="font-size:24px;font-weight:800;color:#4ade80;">${{ parlay_payout }}</div>
                <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;">Pays on $10</div>
            </div>
            <div style="border-left:1px solid rgba(255,255,255,0.1);"></div>
            <div>
                <div style="font-size:24px;font-weight:800;color:#fbbf24;">{{ parlay_calibrated_prob if parlay_calibrated_prob else parlay_prob }}%</div>
                <div style="font-size:11px;color:#94a3b8;text-transform:uppercase;">{% if parlay_calibrated_prob %}Cal Prob{% else %}Model Prob{% endif %}</div>
            </div>
        </div>
        <div style="text-align:center;margin-top:14px;font-size:11px;color:#475569;">baseball.mcdevitt.page</div>
    </div>
</div>
{% endif %}


{% if confident_bets %}
<div class="card mb-4">
    <div class="card-header bg-maroon">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-people-fill"></i> Best Bets ‚Äî Model Consensus</span>
            <small class="text-white-50">7/12+ models agree | +1% bonus per model above 5</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in confident_bets %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-primary" data-game-id="{{ game.game_id }}" style="cursor:pointer" onclick="window.location='/game/{{ game.game_id }}'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <div>
                                {% if game.adjusted_edge %}
                                <span class="badge bg-success">+{{ game.adjusted_edge|round(1) }}%</span>
                                {% endif %}
                                {% if game.bucket %}
                                <span class="badge bg-{{ game.bucket.color }}">{{ game.bucket.label }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <h6 class="mb-1 fw-bold d-flex align-items-center">
                            <img src="{{ team_logo(game.home_team_id if game.model_agreement.pick == 'home' else game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            {% if game.model_agreement.pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">{{ game.away_team_name }} @ {{ game.home_team_name }}</small>
                        <div class="mb-2">
                            {{ agreement_meter(game.model_agreement.count, game.model_agreement.total, 'md') }}
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">
                                {% if game.model_agreement.pick == 'home' %}{{ game.home_ml|format_odds }}{% else %}{{ game.away_ml|format_odds }}{% endif %}
                            </span>
                            <span class="badge bg-info" title="Raw model confidence">{{ (game.model_agreement.avg_prob * 100)|round(0) }}% conf</span>
                            {% if game.calibrated_edge is defined and game.calibrated_edge is not none %}
                            <span class="badge bg-{{ 'success' if game.calibrated_edge > 5 else 'warning text-dark' if game.calibrated_edge > 0 else 'danger' }}" title="Calibrated edge (adjusted for model overconfidence)">
                                {{ game.calibrated_edge|round(1) }}% cal
                            </span>
                            {% endif %}
                        </div>
                        {% if game.series_probs %}
                        {% set sp = game.series_probs %}
                        {% set pick = game.model_agreement.pick %}
                        <div class="mt-2 pt-2 border-top">
                            <small class="text-muted">Series: </small>
                            <small>{{ ((sp.home_win_1plus if pick == 'home' else sp.away_win_1plus) * 100)|round(0) }}%</small>
                            <small class="text-muted"> / </small>
                            <small>{{ ((sp.home_win_2plus if pick == 'home' else sp.away_win_2plus) * 100)|round(0) }}%</small>
                            <small class="text-muted"> / </small>
                            <small>{{ ((sp.home_sweep if pick == 'home' else sp.away_sweep) * 100)|round(0) }}%</small>
                            <small class="text-muted ms-1" title="Win 1+ / Win 2+ / Sweep"><i class="bi bi-info-circle"></i></small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if ev_bets %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #10b981; color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-lightning-charge-fill"></i> Best EV Bets (v2)</span>
            <small class="text-white-50">{{ v2_thresholds.ml_favorite|default(8) }}%+ edge over DK line | Sorted by raw edge</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in ev_bets[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success" data-game-id="{{ game.game_id }}" style="cursor:pointer" onclick="window.location='/game/{{ game.game_id }}'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <div>
                                {% if game.adjusted_edge and game.adjusted_edge != game.best_edge %}
                                <span class="badge bg-success" title="Raw: {{ game.best_edge|round(1) }}%">{{ game.adjusted_edge|round(1) }}% adj</span>
                                {% else %}
                                <span class="badge bg-success">+{{ game.best_edge|round(1) }}%</span>
                                {% endif %}
                                {% if game.models_agree and game.models_agree >= 6 %}
                                {{ agreement_meter(game.models_agree, game.model_agreement.total if game.model_agreement else 11, 'sm') }}
                                {% endif %}
                                {% if game.is_underdog %}
                                <span class="badge bg-warning text-dark" title="50% edge discount applied">üêï</span>
                                {% endif %}
                                {% if game.bucket %}
                                <span class="badge bg-{{ game.bucket.color }}">{{ game.bucket.label }}</span>
                                {% endif %}
                            </div>
                        </div>
                        <h6 class="mb-1 d-flex align-items-center">
                            <img src="{{ team_logo(game.home_team_id if game.best_pick == 'home' else game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            {% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">{{ game.away_team_name }} @ {{ game.home_team_name }}</small>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{% if game.best_pick == 'home' %}{{ game.home_ml|format_odds }}{% else %}{{ game.away_ml|format_odds }}{% endif %}</span>
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                EV: {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}/100
                            </span>
                            {% endif %}
                            {% if game.calibrated_edge is defined and game.calibrated_edge is not none %}
                            <span class="badge bg-{{ 'success' if game.calibrated_edge > 5 else 'warning text-dark' if game.calibrated_edge > 0 else 'danger' }}" title="Calibrated edge (adjusted for model overconfidence)">
                                {{ game.calibrated_edge|round(1) }}% cal
                            </span>
                            {% endif %}
                        </div>
                        {% if game.series_probs %}
                        {% set sp = game.series_probs %}
                        {% set pick = game.best_pick %}
                        <div class="mt-2 pt-2 border-top">
                            <small class="text-muted">Series: </small>
                            <small>{{ ((sp.home_win_1plus if pick == 'home' else sp.away_win_1plus) * 100)|round(0) }}%</small>
                            <small class="text-muted"> / </small>
                            <small>{{ ((sp.home_win_2plus if pick == 'home' else sp.away_win_2plus) * 100)|round(0) }}%</small>
                            <small class="text-muted"> / </small>
                            <small>{{ ((sp.home_sweep if pick == 'home' else sp.away_sweep) * 100)|round(0) }}%</small>
                            <small class="text-muted ms-1" title="Win 1+ / Win 2+ / Sweep"><i class="bi bi-info-circle"></i></small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if best_totals %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #2563eb; color: white;">
        <i class="bi bi-graph-up"></i> Best Totals (15%+ Edge)
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in best_totals[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 {% if game.total_lean == 'OVER' %}border-success{% else %}border-danger{% endif %}" data-game-id="{{ game.game_id }}" style="cursor:pointer" onclick="window.location='/game/{{ game.game_id }}'">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <span class="badge {% if game.total_lean == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {% if game.total_prob %}{{ game.total_lean }} {{ (game.total_prob * 100)|round(0) }}%{% else %}{{ game.total_lean }} +{{ game.total_edge|round(0) }}%{% endif %}
                            </span>
                        </div>
                        <h6 class="mb-1">{{ game.away_team_name }} @ {{ game.home_team_name }}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <span class="fw-bold">O/U {{ game.over_under }}</span><br>
                                <small class="text-muted">Proj: {{ game.projected_total|round(1) }}</small>
                            </div>
                            <div class="text-end">
                                <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %} fw-bold">{{ game.total_lean }}</span><br>
                                <small class="text-muted">Diff: {{ '%+.1f'|format(game.total_diff) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- All Games Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-list"></i> All Games with Lines</span>
            <div class="d-flex gap-1 flex-wrap">
                <span class="text-muted small me-1 align-self-center">Sort:</span>
                <button class="btn btn-sm btn-outline-primary active" onclick="sortTable('consensus', this)" title="Model agreement">Consensus</button>
                <button class="btn btn-sm btn-outline-success" onclick="sortTable('edge', this)" title="Edge over DK line">Edge</button>
                <button class="btn btn-sm btn-outline-info" onclick="sortTable('ev', this)" title="Expected value per $100">EV</button>
                <button class="btn btn-sm btn-outline-warning" onclick="sortTable('confidence', this)" title="Blended model confidence">Confidence</button>
                <span class="badge bg-secondary align-self-center">{{ games|length }} games</span>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if games %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="allGamesTable">
                <thead>
                    <tr>
                        <th>Matchup</th>
                        <th class="text-center">DK ML</th>
                        <th class="text-center">FD ML</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('consensus', null)">Consensus ‚Üï</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('confidence', null)">Blended ‚Üï</th>
                        <th class="text-center">Neural</th>
                        <th class="text-center">Ensemble</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('edge', null)">Edge ‚Üï</th>
                        <th class="text-center">DK O/U</th>
                        <th class="text-center">FD O/U</th>
                        <th class="text-center">NN Total</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('ev', null)">EV/100 ‚Üï</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr data-game-id="{{ game.game_id }}"
                        data-consensus="{{ game.model_agreement.count if game.model_agreement else 0 }}"
                        data-confidence="{{ game.model_agreement.confidence|round(1) if game.model_agreement and game.model_agreement.confidence else 0 }}"
                        data-edge="{{ game.best_edge|round(1) if game.best_edge else 0 }}"
                        data-ev="{{ game.ev_per_100|round(1) if game.ev_per_100 else -999 }}"
                        style="cursor:pointer" onclick="window.location='/game/{{ game.game_id }}'">
                        <td>
                            <div class="d-flex flex-column">
                                <span>
                                    {% if game.away_rank %}<small class="text-muted">#{{ game.away_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.away_team_id }}" class="team-link" onclick="event.stopPropagation();">{{ game.away_team_name }}</a>
                                </span>
                                <small class="text-muted">@</small>
                                <span>
                                    {% if game.home_rank %}<small class="text-muted">#{{ game.home_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.home_team_id }}" class="team-link" onclick="event.stopPropagation();">{{ game.home_team_name }}</a>
                                </span>
                                {% if game.bucket %}
                                <small class="mt-1"><span class="badge bg-{{ game.bucket.color }}">{{ game.bucket.label }}</span></small>
                                {% endif %}
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column">
                                <span>{{ game.away_ml|format_odds }}</span>
                                <span>{{ game.home_ml|format_odds }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if game.fd_away_ml or game.fd_home_ml %}
                            <div class="d-flex flex-column">
                                <span>{{ game.fd_away_ml|format_odds }}</span>
                                <span>{{ game.fd_home_ml|format_odds }}</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.model_agreement %}
                            {% set ma = game.model_agreement %}
                            <div title="{{ ma.models_for|join(', ') }}">
                                {{ agreement_meter(ma.count, ma.total, 'sm') }}
                            </div>
                            <small class="text-muted">{% if ma.pick == 'home' %}{{ (game.home_team_name or 'Home')[:8] }}{% else %}{{ (game.away_team_name or 'Away')[:8] }}{% endif %}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.model_away_prob %}
                            <div class="d-flex flex-column">
                                <span>{{ (game.model_away_prob * 100)|round(1) }}%</span>
                                <span>{{ (game.model_home_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_prob is defined and game.nn_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.nn_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.nn_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ens_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.ens_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.ens_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.best_edge %}
                            <span class="{% if game.best_edge >= 5 %}text-success fw-bold{% elif game.best_edge >= 2 %}text-warning{% else %}text-muted{% endif %}">
                                +{{ game.best_edge|round(1) }}%
                            </span>
                            <br><small class="text-muted">{% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.over_under and game.projected_total %}
                            <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %}">
                                {{ game.total_lean }}
                            </span>
                            <br><small class="text-muted">{{ game.over_under }} | {{ game.projected_total|round(1) }}</small>
                            {% elif game.over_under %}
                            <small class="text-muted">{{ game.over_under }}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.fd_over_under %}
                            <small class="text-muted">{{ game.fd_over_under }}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_total %}
                            <span class="fw-bold">{{ game.nn_total|round(1) }}</span>
                            {% if game.nn_over_prob and game.over_under %}
                            <br><small class="{% if game.nn_over_prob > 0.55 %}text-success{% elif game.nn_under_prob > 0.55 %}text-danger{% else %}text-muted{% endif %}">
                                {% if game.nn_over_prob > 0.5 %}O {{ (game.nn_over_prob * 100)|round(0) }}%{% else %}U {{ (game.nn_under_prob * 100)|round(0) }}%{% endif %}
                            </small>
                            {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 5 %}bg-success{% elif game.ev_per_100 > 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}
                            </span>
                            {% else %}‚Äî{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="mt-3 text-muted">No betting lines available</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Info Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-people text-primary"></i> Model Consensus (Best Bets)</h6>
                <p class="small text-muted mb-0">
                    Runs all 10 models and picks games where <strong>7+ agree</strong>. Sorted by confidence = agreement% √ó avg probability. Highest conviction picks.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-lightning-charge text-success"></i> Highest EV (Edge Over DK)</h6>
                <p class="small text-muted mb-0">
                    Edge = Model probability - DK implied probability. <strong>5%+ edge</strong> means our blended model sees more value than the line suggests.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-exclamation-triangle text-warning"></i> Disclaimer</h6>
                <p class="small text-muted mb-0">For entertainment purposes only. Gamble responsibly.</p>
            </div>
        </div>
    </div>
</div>

<script>
function sortTable(criterion, btn) {
    const table = document.getElementById('allGamesTable');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        switch(criterion) {
            case 'consensus':
                aVal = parseFloat(a.dataset.consensus) || 0;
                bVal = parseFloat(b.dataset.consensus) || 0;
                if (aVal === bVal) {
                    aVal = parseFloat(a.dataset.confidence) || 0;
                    bVal = parseFloat(b.dataset.confidence) || 0;
                }
                break;
            case 'edge':
                aVal = parseFloat(a.dataset.edge) || 0;
                bVal = parseFloat(b.dataset.edge) || 0;
                break;
            case 'ev':
                aVal = parseFloat(a.dataset.ev) || -999;
                bVal = parseFloat(b.dataset.ev) || -999;
                break;
            case 'confidence':
                aVal = parseFloat(a.dataset.confidence) || 0;
                bVal = parseFloat(b.dataset.confidence) || 0;
                break;
        }
        return bVal - aVal;
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    // Update button states
    if (btn) {
        document.querySelectorAll('.card-header .btn-sm').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
}

// Sort by consensus on page load
document.addEventListener('DOMContentLoaded', () => sortTable('consensus', document.querySelector('.btn-sm.active')));
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
async function shareParlay() {
    const card = document.getElementById('parlayShareCard');
    if (!card) return;
    
    // Temporarily make visible for rendering
    card.style.position = 'fixed';
    card.style.left = '0';
    card.style.top = '0';
    card.style.zIndex = '-1';
    card.style.opacity = '1';
    
    try {
        const canvas = await html2canvas(card.firstElementChild, {
            backgroundColor: null,
            scale: 2,
            useCORS: true,
            logging: false,
        });
        
        // Hide again
        card.style.position = 'absolute';
        card.style.left = '-9999px';
        
        // Try native share (mobile), fallback to download
        canvas.toBlob(async (blob) => {
            const file = new File([blob], 'parlay-of-the-day.png', { type: 'image/png' });
            
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        title: '4-Leg Parlay of the Day',
                        text: 'Check out today\'s parlay pick! ‚öæ'
                    });
                    return;
                } catch (e) {
                    if (e.name === 'AbortError') return;
                }
            }
            
            // Desktop: download. Mobile already handled above via navigator.share.
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'parlay-of-the-day.png';
            a.click();
            URL.revokeObjectURL(url);
            const btn = document.querySelector('[onclick="shareParlay()"]');
            const origHtml = btn.innerHTML;
            btn.innerHTML = '<i class="bi bi-download"></i> Downloaded!';
            setTimeout(() => btn.innerHTML = origHtml, 2000);
        }, 'image/png');
    } catch (e) {
        card.style.position = 'absolute';
        card.style.left = '-9999px';
        console.error('Share failed:', e);
        alert('Failed to generate image');
    }
}
</script>
<script src="/static/js/betting-links.js"></script>
{% endblock %}
