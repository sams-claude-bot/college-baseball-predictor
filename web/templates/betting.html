{% extends "base.html" %}

{% block title %}Betting Analysis - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1">
            <i class="bi bi-currency-dollar"></i> Betting Analysis
        </h1>
        <p class="text-muted mb-0">Compare model predictions to DraftKings lines and find value</p>
    </div>
    <div>
        <select class="form-select form-select-sm" style="width: auto;"
                onchange="window.location.href='/betting?conference=' + encodeURIComponent(this.value)">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

{% if best_bets %}
<!-- Best Bets Section -->
<div class="card mb-4">
    <div class="card-header bg-maroon">
        <i class="bi bi-lightning-charge-fill"></i> Best Bets (5%+ Edge)
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in best_bets[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <span class="badge bg-success">+{{ game.best_edge|round(1) }}%</span>
                        </div>
                        <h6 class="mb-1">
                            {% if game.best_pick == 'home' %}
                            {{ game.home_team_name }}
                            {% else %}
                            {{ game.away_team_name }}
                            {% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">
                            {{ game.away_team_name }} @ {{ game.home_team_name }}
                        </small>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                {% if game.best_pick == 'home' %}
                                {{ game.home_ml|format_odds }}
                                {% else %}
                                {{ game.away_ml|format_odds }}
                                {% endif %}
                            </span>
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                EV: {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}/100
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- All Games with Lines -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list"></i> All Games with Lines</span>
            <span class="badge bg-secondary">{{ games|length }} games</span>
        </div>
    </div>
    <div class="card-body p-0">
        {% if games %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matchup</th>
                        <th class="text-center">DK Lines</th>
                        <th class="text-center">Model Prob</th>
                        <th class="text-center">Edge</th>
                        <th class="text-center">O/U Analysis</th>
                        <th class="text-center">EV/100</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td>
                            <small>{{ game.date }}</small>
                        </td>
                        <td>
                            <div class="d-flex flex-column">
                                <span>
                                    {% if game.away_rank %}<small class="text-muted">#{{ game.away_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.away_team_id }}" class="team-link">{{ game.away_team_name }}</a>
                                </span>
                                <small class="text-muted">@</small>
                                <span>
                                    {% if game.home_rank %}<small class="text-muted">#{{ game.home_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.home_team_id }}" class="team-link">{{ game.home_team_name }}</a>
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column">
                                <span>{{ game.away_ml|format_odds }}</span>
                                <span>{{ game.home_ml|format_odds }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if game.model_away_prob %}
                            <div class="d-flex flex-column">
                                <span>{{ (game.model_away_prob * 100)|round(1) }}%</span>
                                <span>{{ (game.model_home_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.best_edge %}
                            <div class="d-flex flex-column align-items-center">
                                <span class="{% if game.best_edge >= 5 %}text-success fw-bold{% elif game.best_edge >= 2 %}text-warning{% else %}text-muted{% endif %}">
                                    {{ '+' if game.best_edge > 0 else '' }}{{ game.best_edge|round(1) }}%
                                </span>
                                <small class="text-muted">
                                    {% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                                </small>
                            </div>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.over_under and game.projected_total %}
                            <div class="d-flex flex-column align-items-center">
                                <span class="{% if game.total_diff|abs > 1 %}fw-bold{% endif %} {% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %}">
                                    {{ game.total_lean }}
                                </span>
                                <small class="text-muted">
                                    O/U {{ game.over_under }} | Proj {{ game.projected_total|round(1) }}
                                </small>
                            </div>
                            {% elif game.over_under %}
                            <small class="text-muted">O/U {{ game.over_under }}</small>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 5 %}bg-success{% elif game.ev_per_100 > 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}
                            </span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="mt-3 text-muted">No betting lines available</p>
            <p class="small text-muted">Lines will appear here once loaded via the CLI</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Info Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-info-circle text-primary"></i> Understanding Edge</h6>
                <p class="small text-muted mb-0">
                    Edge = Model probability - DraftKings implied probability.
                    A positive edge means the model thinks the team is more likely to win than DK implies.
                    <strong>5%+ edge</strong> is generally considered significant.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-calculator text-success"></i> Expected Value (EV)</h6>
                <p class="small text-muted mb-0">
                    EV per $100 shows the expected profit/loss per $100 bet based on model probabilities.
                    Positive EV means the bet is +EV according to our models.
                    <strong>This is theoretical</strong> — actual results vary.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-exclamation-triangle text-warning"></i> Disclaimer</h6>
                <p class="small text-muted mb-0">
                    This is for entertainment purposes only. Model predictions are estimates and not financial advice.
                    Gamble responsibly.
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
