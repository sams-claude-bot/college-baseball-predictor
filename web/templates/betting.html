{% extends "base.html" %}

{% block title %}Betting Analysis - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-currency-dollar"></i> Betting Analysis</h1>
        <p class="text-muted mb-0">Compare model predictions to DraftKings lines and find value</p>
    </div>
    <div>
        <select class="form-select form-select-sm" style="width: auto;"
                onchange="window.location.href='/betting?conference=' + encodeURIComponent(this.value)">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Model Agreement Legend -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <strong class="me-2"><i class="bi bi-info-circle"></i> Model Signals:</strong>
            <span><span class="badge bg-primary">X/12</span> Number of models agreeing on pick</span>
            <span><span class="badge bg-success">AGREE</span> Both NN &amp; Ensemble agree with &gt;60% confidence</span>
            <span><span class="badge bg-danger">SPLIT</span> Models disagree on the winner</span>
        </div>
    </div>
</div>

{% if confident_bets %}
<div class="card mb-4">
    <div class="card-header bg-maroon">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-people-fill"></i> Best Bets ‚Äî Model Consensus</span>
            <small class="text-white-50">7/12+ models agree | +1% bonus per model above 5</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in confident_bets %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <div>
                                <span class="badge bg-primary">{{ game.model_agreement.count }}/{{ game.model_agreement.total }} models</span>
                                {% if game.adjusted_edge %}
                                <span class="badge bg-success">{{ game.adjusted_edge|round(1) }}% adj</span>
                                {% endif %}
                            </div>
                        </div>
                        <h6 class="mb-1">
                            {% if game.model_agreement.pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">{{ game.away_team_name }} @ {{ game.home_team_name }}</small>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>
                                {% if game.model_agreement.pick == 'home' %}{{ game.home_ml|format_odds }}{% else %}{{ game.away_ml|format_odds }}{% endif %}
                            </span>
                            <span class="badge bg-info">{{ (game.model_agreement.avg_prob * 100)|round(0) }}% avg conf</span>
                        </div>
                        <div class="small text-muted" title="{{ game.model_agreement.models_for|join(', ') }}">
                            <i class="bi bi-check-circle text-success"></i> {{ game.model_agreement.models_for[:3]|join(', ') }}{% if game.model_agreement.models_for|length > 3 %}...{% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if ev_bets %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #10b981; color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-lightning-charge-fill"></i> Best EV Bets (v2)</span>
            <small class="text-white-50">{{ v2_thresholds.ml_favorite|default(8) }}%+ edge over DK line | Sorted by raw edge</small>
        </div>
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in ev_bets[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <div>
                                {% if game.adjusted_edge and game.adjusted_edge != game.best_edge %}
                                <span class="badge bg-success" title="Raw: {{ game.best_edge|round(1) }}%">{{ game.adjusted_edge|round(1) }}% adj</span>
                                {% else %}
                                <span class="badge bg-success">+{{ game.best_edge|round(1) }}%</span>
                                {% endif %}
                                {% if game.models_agree and game.models_agree >= 7 %}
                                <span class="badge bg-primary">{{ game.models_agree }}/{{ game.model_agreement.total if game.model_agreement else 12 }}</span>
                                {% endif %}
                                {% if game.is_underdog %}
                                <span class="badge bg-warning text-dark" title="50% edge discount applied">üêï</span>
                                {% endif %}
                            </div>
                        </div>
                        <h6 class="mb-1">
                            {% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">{{ game.away_team_name }} @ {{ game.home_team_name }}</small>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{% if game.best_pick == 'home' %}{{ game.home_ml|format_odds }}{% else %}{{ game.away_ml|format_odds }}{% endif %}</span>
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                EV: {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}/100
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if best_totals %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #2563eb; color: white;">
        <i class="bi bi-graph-up"></i> Best Totals (15%+ Edge)
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in best_totals[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 {% if game.total_lean == 'OVER' %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <span class="badge {% if game.total_lean == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ game.total_lean }} +{{ game.total_edge|round(0) }}%
                            </span>
                        </div>
                        <h6 class="mb-1">{{ game.away_team_name }} @ {{ game.home_team_name }}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <span class="fw-bold">O/U {{ game.over_under }}</span><br>
                                <small class="text-muted">Proj: {{ game.projected_total|round(1) }}</small>
                            </div>
                            <div class="text-end">
                                <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %} fw-bold">{{ game.total_lean }}</span><br>
                                <small class="text-muted">Diff: {{ '%+.1f'|format(game.total_diff) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- All Games Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span><i class="bi bi-list"></i> All Games with Lines</span>
            <div class="d-flex gap-1 flex-wrap">
                <span class="text-muted small me-1 align-self-center">Sort:</span>
                <button class="btn btn-sm btn-outline-primary active" onclick="sortTable('consensus', this)" title="Model agreement">Consensus</button>
                <button class="btn btn-sm btn-outline-success" onclick="sortTable('edge', this)" title="Edge over DK line">Edge</button>
                <button class="btn btn-sm btn-outline-info" onclick="sortTable('ev', this)" title="Expected value per $100">EV</button>
                <button class="btn btn-sm btn-outline-warning" onclick="sortTable('confidence', this)" title="Blended model confidence">Confidence</button>
                <span class="badge bg-secondary align-self-center">{{ games|length }} games</span>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if games %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="allGamesTable">
                <thead>
                    <tr>
                        <th>Matchup</th>
                        <th class="text-center">DK Lines</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('consensus', null)">Consensus ‚Üï</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('confidence', null)">Blended ‚Üï</th>
                        <th class="text-center">Neural</th>
                        <th class="text-center">Ensemble</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('edge', null)">Edge ‚Üï</th>
                        <th class="text-center">O/U</th>
                        <th class="text-center">NN Total</th>
                        <th class="text-center">NN Spread</th>
                        <th class="text-center" style="cursor:pointer" onclick="sortTable('ev', null)">EV/100 ‚Üï</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr data-consensus="{{ game.model_agreement.count if game.model_agreement else 0 }}"
                        data-confidence="{{ game.model_agreement.confidence|round(1) if game.model_agreement and game.model_agreement.confidence else 0 }}"
                        data-edge="{{ game.best_edge|round(1) if game.best_edge else 0 }}"
                        data-ev="{{ game.ev_per_100|round(1) if game.ev_per_100 else -999 }}">
                        <td>
                            <div class="d-flex flex-column">
                                <span>
                                    {% if game.away_rank %}<small class="text-muted">#{{ game.away_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.away_team_id }}" class="team-link">{{ game.away_team_name }}</a>
                                </span>
                                <small class="text-muted">@</small>
                                <span>
                                    {% if game.home_rank %}<small class="text-muted">#{{ game.home_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.home_team_id }}" class="team-link">{{ game.home_team_name }}</a>
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column">
                                <span>{{ game.away_ml|format_odds }}</span>
                                <span>{{ game.home_ml|format_odds }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if game.model_agreement %}
                            {% set ma = game.model_agreement %}
                            <span class="badge {% if ma.count >= 9 %}bg-success{% elif ma.count >= 7 %}bg-primary{% else %}bg-secondary{% endif %}" 
                                  title="{{ ma.models_for|join(', ') }}">
                                {{ ma.count }}/{{ ma.total }}
                            </span>
                            <br><small class="text-muted">{% if ma.pick == 'home' %}{{ (game.home_team_name or 'Home')[:8] }}{% else %}{{ (game.away_team_name or 'Away')[:8] }}{% endif %}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.model_away_prob %}
                            <div class="d-flex flex-column">
                                <span>{{ (game.model_away_prob * 100)|round(1) }}%</span>
                                <span>{{ (game.model_home_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_prob is defined and game.nn_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.nn_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.nn_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ens_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.ens_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.ens_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.best_edge %}
                            <span class="{% if game.best_edge >= 5 %}text-success fw-bold{% elif game.best_edge >= 2 %}text-warning{% else %}text-muted{% endif %}">
                                +{{ game.best_edge|round(1) }}%
                            </span>
                            <br><small class="text-muted">{% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.over_under and game.projected_total %}
                            <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %}">
                                {{ game.total_lean }}
                            </span>
                            <br><small class="text-muted">{{ game.over_under }} | {{ game.projected_total|round(1) }}</small>
                            {% elif game.over_under %}
                            <small class="text-muted">{{ game.over_under }}</small>
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_total %}
                            <span class="fw-bold">{{ game.nn_total|round(1) }}</span>
                            {% if game.nn_over_prob and game.over_under %}
                            <br><small class="{% if game.nn_over_prob > 0.55 %}text-success{% elif game.nn_under_prob > 0.55 %}text-danger{% else %}text-muted{% endif %}">
                                {% if game.nn_over_prob > 0.5 %}O {{ (game.nn_over_prob * 100)|round(0) }}%{% else %}U {{ (game.nn_under_prob * 100)|round(0) }}%{% endif %}
                            </small>
                            {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_margin is defined and game.nn_margin is not none %}
                            <span class="fw-bold">{{ '%+.1f'|format(game.nn_margin) }}</span>
                            {% if game.nn_cover_prob %}
                            <br><small class="{% if game.nn_cover_prob > 0.55 %}text-success{% elif game.nn_cover_prob < 0.45 %}text-danger{% else %}text-muted{% endif %}">
                                Cover {{ (game.nn_cover_prob * 100)|round(0) }}%
                            </small>
                            {% endif %}
                            {% else %}‚Äî{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 5 %}bg-success{% elif game.ev_per_100 > 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}
                            </span>
                            {% else %}‚Äî{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="mt-3 text-muted">No betting lines available</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Info Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-people text-primary"></i> Model Consensus (Best Bets)</h6>
                <p class="small text-muted mb-0">
                    Runs all 10 models and picks games where <strong>7+ agree</strong>. Sorted by confidence = agreement% √ó avg probability. Highest conviction picks.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-lightning-charge text-success"></i> Highest EV (Edge Over DK)</h6>
                <p class="small text-muted mb-0">
                    Edge = Model probability - DK implied probability. <strong>5%+ edge</strong> means our blended model sees more value than the line suggests.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-exclamation-triangle text-warning"></i> Disclaimer</h6>
                <p class="small text-muted mb-0">For entertainment purposes only. Gamble responsibly.</p>
            </div>
        </div>
    </div>
</div>

<script>
function sortTable(criterion, btn) {
    const table = document.getElementById('allGamesTable');
    if (!table) return;
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    rows.sort((a, b) => {
        let aVal, bVal;
        switch(criterion) {
            case 'consensus':
                aVal = parseFloat(a.dataset.consensus) || 0;
                bVal = parseFloat(b.dataset.consensus) || 0;
                if (aVal === bVal) {
                    aVal = parseFloat(a.dataset.confidence) || 0;
                    bVal = parseFloat(b.dataset.confidence) || 0;
                }
                break;
            case 'edge':
                aVal = parseFloat(a.dataset.edge) || 0;
                bVal = parseFloat(b.dataset.edge) || 0;
                break;
            case 'ev':
                aVal = parseFloat(a.dataset.ev) || -999;
                bVal = parseFloat(b.dataset.ev) || -999;
                break;
            case 'confidence':
                aVal = parseFloat(a.dataset.confidence) || 0;
                bVal = parseFloat(b.dataset.confidence) || 0;
                break;
        }
        return bVal - aVal;
    });
    
    rows.forEach(row => tbody.appendChild(row));
    
    // Update button states
    if (btn) {
        document.querySelectorAll('.card-header .btn-sm').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
}

// Sort by consensus on page load
document.addEventListener('DOMContentLoaded', () => sortTable('consensus', document.querySelector('.btn-sm.active')));
</script>
{% endblock %}
