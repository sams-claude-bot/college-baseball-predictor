{% extends "base.html" %}

{% block title %}Betting Analysis - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h3 mb-1"><i class="bi bi-currency-dollar"></i> Betting Analysis</h1>
        <p class="text-muted mb-0">Compare model predictions to DraftKings lines and find value</p>
    </div>
    <div>
        <select class="form-select form-select-sm" style="width: auto;"
                onchange="window.location.href='/betting?conference=' + encodeURIComponent(this.value)">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Model Agreement Legend -->
<div class="card mb-4">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3 align-items-center">
            <strong class="me-2"><i class="bi bi-info-circle"></i> Model Signals:</strong>
            <span><span class="badge bg-success">AGREE</span> Both models agree on pick with &gt;60% confidence</span>
            <span><span class="badge bg-danger">SPLIT</span> Models disagree on the winner</span>
            <span class="text-muted">| <strong>NN</strong> = Neural Network, <strong>ENS</strong> = Ensemble</span>
        </div>
    </div>
</div>

{% if best_bets %}
<div class="card mb-4">
    <div class="card-header bg-maroon">
        <i class="bi bi-lightning-charge-fill"></i> Best Bets (5%+ Edge)
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in best_bets[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <div>
                                <span class="badge bg-success">+{{ game.best_edge|round(1) }}%</span>
                                {% if game.nn_prob is not none and game.ens_prob is not none %}
                                    {% set nn_home_fav = game.nn_prob > 0.5 %}
                                    {% set ens_home_fav = game.ens_prob > 0.5 %}
                                    {% if nn_home_fav == ens_home_fav and (game.nn_prob > 0.6 or game.nn_prob < 0.4) and (game.ens_prob > 0.6 or game.ens_prob < 0.4) %}
                                    <span class="badge bg-success">AGREE</span>
                                    {% elif nn_home_fav != ens_home_fav %}
                                    <span class="badge bg-danger">SPLIT</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                        <h6 class="mb-1">
                            {% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}
                        </h6>
                        <small class="text-muted d-block mb-2">{{ game.away_team_name }} @ {{ game.home_team_name }}</small>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>{% if game.best_pick == 'home' %}{{ game.home_ml|format_odds }}{% else %}{{ game.away_ml|format_odds }}{% endif %}</span>
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 0 %}bg-success{% else %}bg-secondary{% endif %}">
                                EV: {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}/100
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

{% if best_totals %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #2563eb; color: white;">
        <i class="bi bi-graph-up"></i> Best Totals (15%+ Edge)
    </div>
    <div class="card-body">
        <div class="row">
            {% for game in best_totals[:6] %}
            <div class="col-md-4 mb-3">
                <div class="card h-100 {% if game.total_lean == 'OVER' %}border-success{% else %}border-danger{% endif %}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <small class="text-muted">{{ game.date }}</small>
                            <span class="badge {% if game.total_lean == 'OVER' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ game.total_lean }} +{{ game.total_edge|round(0) }}%
                            </span>
                        </div>
                        <h6 class="mb-1">{{ game.away_team_name }} @ {{ game.home_team_name }}</h6>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div>
                                <span class="fw-bold">O/U {{ game.over_under }}</span><br>
                                <small class="text-muted">Proj: {{ game.projected_total|round(1) }}</small>
                            </div>
                            <div class="text-end">
                                <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %} fw-bold">{{ game.total_lean }}</span><br>
                                <small class="text-muted">Diff: {{ '%+.1f'|format(game.total_diff) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- All Games Table -->
<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-list"></i> All Games with Lines</span>
            <span class="badge bg-secondary">{{ games|length }} games</span>
        </div>
    </div>
    <div class="card-body p-0">
        {% if games %}
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Matchup</th>
                        <th class="text-center">DK Lines</th>
                        <th class="text-center">Blended</th>
                        <th class="text-center">Neural</th>
                        <th class="text-center">Ensemble</th>
                        <th class="text-center">Signal</th>
                        <th class="text-center">Edge</th>
                        <th class="text-center">O/U</th>
                        <th class="text-center">NN Total</th>
                        <th class="text-center">NN Spread</th>
                        <th class="text-center">EV/100</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game in games %}
                    <tr>
                        <td>
                            <div class="d-flex flex-column">
                                <span>
                                    {% if game.away_rank %}<small class="text-muted">#{{ game.away_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.away_team_id }}" class="team-link">{{ game.away_team_name }}</a>
                                </span>
                                <small class="text-muted">@</small>
                                <span>
                                    {% if game.home_rank %}<small class="text-muted">#{{ game.home_rank }}</small> {% endif %}
                                    <a href="/team/{{ game.home_team_id }}" class="team-link">{{ game.home_team_name }}</a>
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="d-flex flex-column">
                                <span>{{ game.away_ml|format_odds }}</span>
                                <span>{{ game.home_ml|format_odds }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if game.model_away_prob %}
                            <div class="d-flex flex-column">
                                <span>{{ (game.model_away_prob * 100)|round(1) }}%</span>
                                <span>{{ (game.model_home_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.nn_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.nn_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ens_prob is not none %}
                            <div class="d-flex flex-column">
                                <span>{{ ((1 - game.ens_prob) * 100)|round(1) }}%</span>
                                <span>{{ (game.ens_prob * 100)|round(1) }}%</span>
                            </div>
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_prob is not none and game.ens_prob is not none %}
                                {% set nn_home_fav = game.nn_prob > 0.5 %}
                                {% set ens_home_fav = game.ens_prob > 0.5 %}
                                {% if nn_home_fav == ens_home_fav and (game.nn_prob > 0.6 or game.nn_prob < 0.4) and (game.ens_prob > 0.6 or game.ens_prob < 0.4) %}
                                <span class="badge bg-success">AGREE</span>
                                {% elif nn_home_fav != ens_home_fav %}
                                <span class="badge bg-danger">SPLIT</span>
                                {% else %}
                                <span class="text-muted">—</span>
                                {% endif %}
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.best_edge %}
                            <span class="{% if game.best_edge >= 5 %}text-success fw-bold{% elif game.best_edge >= 2 %}text-warning{% else %}text-muted{% endif %}">
                                +{{ game.best_edge|round(1) }}%
                            </span>
                            <br><small class="text-muted">{% if game.best_pick == 'home' %}{{ game.home_team_name }}{% else %}{{ game.away_team_name }}{% endif %}</small>
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.over_under and game.projected_total %}
                            <span class="{% if game.total_lean == 'OVER' %}text-success{% else %}text-danger{% endif %}">
                                {{ game.total_lean }}
                            </span>
                            <br><small class="text-muted">{{ game.over_under }} | {{ game.projected_total|round(1) }}</small>
                            {% elif game.over_under %}
                            <small class="text-muted">{{ game.over_under }}</small>
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_total %}
                            <span class="fw-bold">{{ game.nn_total|round(1) }}</span>
                            {% if game.nn_over_prob and game.over_under %}
                            <br><small class="{% if game.nn_over_prob > 0.55 %}text-success{% elif game.nn_under_prob > 0.55 %}text-danger{% else %}text-muted{% endif %}">
                                {% if game.nn_over_prob > 0.5 %}O {{ (game.nn_over_prob * 100)|round(0) }}%{% else %}U {{ (game.nn_under_prob * 100)|round(0) }}%{% endif %}
                            </small>
                            {% endif %}
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.nn_margin is not none %}
                            <span class="fw-bold">{{ '%+.1f'|format(game.nn_margin) }}</span>
                            {% if game.nn_cover_prob %}
                            <br><small class="{% if game.nn_cover_prob > 0.55 %}text-success{% elif game.nn_cover_prob < 0.45 %}text-danger{% else %}text-muted{% endif %}">
                                Cover {{ (game.nn_cover_prob * 100)|round(0) }}%
                            </small>
                            {% endif %}
                            {% else %}—{% endif %}
                        </td>
                        <td class="text-center">
                            {% if game.ev_per_100 %}
                            <span class="badge {% if game.ev_per_100 > 5 %}bg-success{% elif game.ev_per_100 > 0 %}bg-secondary{% else %}bg-danger{% endif %}">
                                {{ '+' if game.ev_per_100 > 0 else '' }}${{ game.ev_per_100|round(2) }}
                            </span>
                            {% else %}—{% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-inbox display-4 text-muted"></i>
            <p class="mt-3 text-muted">No betting lines available</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Info Cards -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-info-circle text-primary"></i> Understanding Edge</h6>
                <p class="small text-muted mb-0">
                    Edge = Model probability - DK implied probability. <strong>5%+ edge</strong> is significant.
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-people text-success"></i> Model Agreement</h6>
                <p class="small text-muted mb-0">
                    <strong>AGREE</strong> = both neural &amp; ensemble pick the same team with &gt;60% confidence. Strongest signal.<br>
                    <strong>SPLIT</strong> = models disagree on the winner — proceed with caution.<br>
                    <strong>No badge</strong> = models agree on the winner but one or both have &lt;60% confidence (gray zone).
                </p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6><i class="bi bi-exclamation-triangle text-warning"></i> Disclaimer</h6>
                <p class="small text-muted mb-0">For entertainment purposes only. Gamble responsibly.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}
