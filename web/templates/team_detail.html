{% extends "base.html" %}

{% block title %}{{ team.name }} - College Baseball Predictor{% endblock %}

{% block content %}
<!-- Team Header -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-8">
                <div class="d-flex align-items-center gap-3">
                    {% if team.current_rank %}
                    <span class="badge bg-maroon fs-4 px-3 py-2">#{{ team.current_rank }}</span>
                    {% endif %}
                    <div>
                        <h1 class="h2 mb-0">{{ team.name }}</h1>
                        {% if team.nickname %}
                        <span class="text-muted fs-5">{{ team.nickname }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="mt-2">
                    <span class="badge bg-secondary">{{ team.conference or 'Independent' }}</span>
                    {% if team.division %}
                    <span class="badge bg-outline-secondary">{{ team.division }}</span>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="row text-center">
                    <div class="col-4">
                        <div class="h4 mb-0">{{ team.overall_record.wins }}-{{ team.overall_record.losses }}</div>
                        <small class="text-muted">Overall</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 mb-0">{{ team.conference_record.wins }}-{{ team.conference_record.losses }}</div>
                        <small class="text-muted">Conference</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 mb-0" style="color: var(--maroon);">
                            {{ (team.elo_rating or 1500)|round(0)|int }}
                        </div>
                        <small class="text-muted">Elo</small>
                    </div>
                </div>
                {% if team.sams_rpi %}
                <hr class="my-2">
                <div class="row text-center">
                    <div class="col-3">
                        <div class="h5 mb-0" style="color: var(--maroon);">#{{ team.sams_rank }}</div>
                        <small class="text-muted">RPI Rank</small>
                    </div>
                    <div class="col-3">
                        <div class="h5 mb-0">{{ team.sams_rpi|round(4) }}</div>
                        <small class="text-muted">RPI</small>
                    </div>
                    <div class="col-2">
                        <div class="h6 mb-0">{{ team.rpi_wp|round(3) }}</div>
                        <small class="text-muted">WP</small>
                    </div>
                    <div class="col-2">
                        <div class="h6 mb-0">{{ team.rpi_owp|round(3) }}</div>
                        <small class="text-muted">OWP</small>
                    </div>
                    <div class="col-2">
                        <div class="h6 mb-0">{{ team.rpi_oowp|round(3) }}</div>
                        <small class="text-muted">OOWP</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column -->
    <div class="col-lg-8">
        <!-- Recent Form -->
        {% if recent_form %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up"></i> Recent Form (Last {{ recent_form|length }} Games)
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    {% for game in recent_form %}
                    {% set is_home = game.home_team_id == team.id %}
                    {% set has_scores = game.home_score is not none and game.away_score is not none %}
                    {% set won = (game.winner_id == team.id) if game.winner_id else ((game.home_score > game.away_score) if (has_scores and is_home) else ((game.away_score > game.home_score) if has_scores else false)) %}
                    {% set opponent = game.away_team_name if is_home else game.home_team_name %}
                    {% if game.status == 'final' and game.home_score is not none and game.away_score is not none and game.winner_id %}
                    {% set our_score = [game.home_score, game.away_score]|max if won else [game.home_score, game.away_score]|min %}
                    {% set their_score = [game.home_score, game.away_score]|min if won else [game.home_score, game.away_score]|max %}
                    {% else %}
                    {% set our_score = game.home_score if is_home else game.away_score %}
                    {% set their_score = game.away_score if is_home else game.home_score %}
                    {% endif %}
                    
                    <div class="text-center p-2 rounded {% if won %}bg-success text-white{% else %}bg-danger text-white{% endif %}"
                         style="min-width: 60px;" title="{{ 'W' if won else 'L' }} vs {{ opponent }} {{ our_score }}-{{ their_score }}">
                        <div class="fw-bold">{{ 'W' if won else 'L' }}</div>
                        <small>{{ our_score }}-{{ their_score }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Full Schedule -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar3"></i> Full Schedule
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Opponent</th>
                                <th class="text-center">Result</th>
                                <th class="text-center">Score</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for game in team.schedule %}
                            {% set is_home = game.home_team_id == team.id %}
                            {% set opponent_id = game.away_team_id if is_home else game.home_team_id %}
                            {% set opponent = game.away_team_name if is_home else game.home_team_name %}
                            {% set has_scores = game.home_score is not none and game.away_score is not none %}
                            {% set won = (game.winner_id == team.id) if game.winner_id else ((game.home_score > game.away_score) if (has_scores and is_home) else ((game.away_score > game.home_score) if has_scores else false)) %}
                            {% if game.status == 'final' and game.home_score is not none and game.away_score is not none and game.winner_id %}
                            {% set our_score = [game.home_score, game.away_score]|max if won else [game.home_score, game.away_score]|min %}
                            {% set their_score = [game.home_score, game.away_score]|min if won else [game.home_score, game.away_score]|max %}
                            {% else %}
                            {% set our_score = game.home_score if is_home else game.away_score %}
                            {% set their_score = game.away_score if is_home else game.home_score %}
                            {% endif %}
                            
                            <tr>
                                <td>
                                    {{ game.date }}
                                    {% if game.time %}<br><small class="text-muted">{{ game.time }}</small>{% endif %}
                                </td>
                                <td>
                                    <span class="text-muted">{{ '@' if not is_home else 'vs' }}</span>
                                    <a href="/team/{{ opponent_id }}" class="team-link">{{ opponent }}</a>
                                    {% if game.is_conference_game %}
                                    <span class="badge bg-secondary ms-1">Conf</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if game.status == 'final' %}
                                    <span class="badge {% if won %}bg-success{% else %}bg-danger{% endif %}">
                                        {{ 'W' if won else 'L' }}
                                    </span>
                                    {% elif game.status == 'scheduled' %}
                                    <span class="badge bg-secondary">Scheduled</span>
                                    {% else %}
                                    <span class="badge bg-warning text-dark">{{ game.status }}</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if game.status == 'final' %}
                                    <strong>{{ our_score }}</strong> - {{ their_score }}
                                    {% else %}
                                    —
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Roster -->
        {% if batters or pitchers %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-person-lines-fill"></i> Roster
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#batters">
                            Batters ({{ batters|length }})
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#pitchers">
                            Pitchers ({{ pitchers|length }})
                        </button>
                    </li>
                </ul>
                <div class="tab-content pt-3">
                    <div class="tab-pane fade show active" id="batters">
                        {% if batters %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Pos</th>
                                        <th>Yr</th>
                                        <th class="text-end">AVG</th>
                                        <th class="text-end">OPS</th>
                                        <th class="text-end">G</th>
                                        <th class="text-end">AB</th>
                                        <th class="text-end">H</th>
                                        <th class="text-end">HR</th>
                                        <th class="text-end">RBI</th>
                                        <th class="text-end">BB</th>
                                        <th class="text-end">SO</th>
                                        <th class="text-end">SB</th>
                                        <th class="text-end text-info">wRC+</th>
                                        <th class="text-end text-info">wOBA</th>
                                        <th class="text-end text-info">ISO</th>
                                        <th class="text-end text-info">BABIP</th>
                                        <th class="text-end text-info">K%</th>
                                        <th class="text-end text-info">BB%</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in batters %}
                                    <tr>
                                        <td>{{ player.number or '' }}</td>
                                        <td>{{ player.name }}</td>
                                        <td><small>{{ player.position or '' }}</small></td>
                                        <td><small>{{ player.year or '' }}</small></td>
                                        <td class="text-end">{{ '%.3f'|format(player.batting_avg) if player.batting_avg else '.000' }}</td>
                                        <td class="text-end">{{ '%.3f'|format(player.ops) if player.ops else '.000' }}</td>
                                        <td class="text-end">{{ player.games or 0 }}</td>
                                        <td class="text-end">{{ player.at_bats or 0 }}</td>
                                        <td class="text-end">{{ player.hits or 0 }}</td>
                                        <td class="text-end">{{ player.home_runs or 0 }}</td>
                                        <td class="text-end">{{ player.rbi or 0 }}</td>
                                        <td class="text-end">{{ player.walks or 0 }}</td>
                                        <td class="text-end">{{ player.strikeouts or 0 }}</td>
                                        <td class="text-end">{{ player.stolen_bases or 0 }}</td>
                                        <td class="text-end text-info">{{ '%d'|format(player.wrc_plus) if player.wrc_plus is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.3f'|format(player.woba) if player.woba is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.3f'|format(player.iso) if player.iso is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.3f'|format(player.babip) if player.babip is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.1f'|format(player.k_pct * 100) if player.k_pct is not none else '' }}{{ '%' if player.k_pct is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.1f'|format(player.bb_pct * 100) if player.bb_pct is not none else '' }}{{ '%' if player.bb_pct is not none else '' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No batting stats available</p>
                        {% endif %}
                    </div>
                    <div class="tab-pane fade" id="pitchers">
                        {% if pitchers %}
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Yr</th>
                                        <th class="text-end">W-L</th>
                                        <th class="text-end">ERA</th>
                                        <th class="text-end">WHIP</th>
                                        <th class="text-end">IP</th>
                                        <th class="text-end">H</th>
                                        <th class="text-end">BB</th>
                                        <th class="text-end">K</th>
                                        <th class="text-end">K/9</th>
                                        <th class="text-end">SV</th>
                                        <th class="text-end text-info">FIP</th>
                                        <th class="text-end text-info">xFIP</th>
                                        <th class="text-end text-info">SIERA</th>
                                        <th class="text-end text-info">K%</th>
                                        <th class="text-end text-info">BB%</th>
                                        <th class="text-end text-info">BABIP</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for player in pitchers %}
                                    <tr>
                                        <td>{{ player.number or '' }}</td>
                                        <td>{{ player.name }}</td>
                                        <td><small>{{ player.year or '' }}</small></td>
                                        <td class="text-end">{{ player.wins or 0 }}-{{ player.losses or 0 }}</td>
                                        <td class="text-end">{{ '%.2f'|format(player.era) if player.era else '0.00' }}</td>
                                        <td class="text-end">{{ '%.2f'|format(player.whip) if player.whip else '0.00' }}</td>
                                        <td class="text-end">{{ player.innings_pitched or 0 }}</td>
                                        <td class="text-end">{{ player.hits_allowed or 0 }}</td>
                                        <td class="text-end">{{ player.walks_allowed or 0 }}</td>
                                        <td class="text-end">{{ player.strikeouts_pitched or 0 }}</td>
                                        <td class="text-end">{{ '%.1f'|format(player.k_per_9) if player.k_per_9 else '0.0' }}</td>
                                        <td class="text-end">{{ player.saves or 0 }}</td>
                                        <td class="text-end text-info">{{ '%.2f'|format(player.fip) if player.fip is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.2f'|format(player.xfip) if player.xfip is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.2f'|format(player.siera) if player.siera is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.1f'|format(player.k_pct_pitch * 100) if player.k_pct_pitch is not none else '' }}{{ '%' if player.k_pct_pitch is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.1f'|format(player.bb_pct_pitch * 100) if player.bb_pct_pitch is not none else '' }}{{ '%' if player.bb_pct_pitch is not none else '' }}</td>
                                        <td class="text-end text-info">{{ '%.3f'|format(player.babip_pitch) if player.babip_pitch is not none else '' }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <p class="text-muted">No pitching stats available</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Right Column -->
    <div class="col-lg-4">
        <!-- Season Stats -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bar-chart"></i> Season Stats
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="h5 mb-0" style="color: var(--maroon);">{{ team.runs.runs_scored }}</div>
                        <small class="text-muted">Runs Scored</small>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="h5 mb-0">{{ team.runs.runs_allowed }}</div>
                        <small class="text-muted">Runs Allowed</small>
                    </div>
                    <div class="col-6">
                        {% if team.runs.games > 0 %}
                        <div class="h5 mb-0">{{ (team.runs.runs_scored / team.runs.games)|round(1) }}</div>
                        {% else %}
                        <div class="h5 mb-0">0.0</div>
                        {% endif %}
                        <small class="text-muted">RS/Game</small>
                    </div>
                    <div class="col-6">
                        {% if team.runs.games > 0 %}
                        <div class="h5 mb-0">{{ (team.runs.runs_allowed / team.runs.games)|round(1) }}</div>
                        {% else %}
                        <div class="h5 mb-0">0.0</div>
                        {% endif %}
                        <small class="text-muted">RA/Game</small>
                    </div>
                </div>
                
                {% if team.runs.runs_scored > 0 or team.runs.runs_allowed > 0 %}
                <hr>
                <div class="mb-2">
                    <small class="text-muted">Run Differential</small>
                    {% set diff = team.runs.runs_scored - team.runs.runs_allowed %}
                    <div class="h4 mb-0 {% if diff > 0 %}text-success{% elif diff < 0 %}text-danger{% endif %}">
                        {{ '+' if diff > 0 else '' }}{{ diff }}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Elo Rating History -->
        {% if team.elo_history %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-graph-up-arrow"></i> Elo Rating
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="display-5 fw-bold" style="color: var(--maroon);">
                        {{ (team.elo_rating or 1500)|round(0)|int }}
                    </div>
                    <small class="text-muted">Current Rating</small>
                </div>
                <canvas id="eloChart" height="150"></canvas>
            </div>
        </div>
        {% endif %}

        <!-- Assumed Lineup -->
        {% if team.assumed_lineup %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-list-ol"></i> Assumed Lineup
                <small class="text-muted float-end">by AB</small>
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th style="width: 25px;" class="text-center">#</th>
                            <th>Player</th>
                            <th class="text-center">Pos</th>
                            <th class="text-end">AVG</th>
                            <th class="text-end">OPS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for p in team.assumed_lineup %}
                        <tr>
                            <td class="text-center text-muted">{{ loop.index }}</td>
                            <td>{{ p.name }}</td>
                            <td class="text-center"><small>{{ p.position or '—' }}</small></td>
                            <td class="text-end">{{ '%.3f'|format(p.batting_avg) if p.batting_avg else '.000' }}</td>
                            <td class="text-end">{{ '%.3f'|format(p.ops) if p.ops else '.000' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Projected Starters -->
        {% if team.projected_starters %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-bullseye"></i> Projected Starters
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <tbody>
                        {% for s in team.projected_starters %}
                        <tr>
                            <td>{{ s.starter_name or 'TBD' }}</td>
                            <td class="text-end text-muted"><small>{{ s.date }} {{ s.location }} {{ s.opponent }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Recent Starters -->
        {% if team.recent_starters %}
        <div class="card">
            <div class="card-header">
                <i class="bi bi-clock-history"></i> Recent Starters
            </div>
            <div class="card-body p-0">
                <table class="table table-sm mb-0">
                    <tbody>
                        {% for s in team.recent_starters %}
                        <tr>
                            <td>{{ s.starting_pitcher }}</td>
                            <td class="text-end text-muted"><small>{{ s.game_date }} vs {{ s.opponent }}</small></td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Quick Predict -->
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calculator"></i> Quick Prediction
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">Predict a game against this team</p>
                <a href="/predict?team={{ team.id }}" class="btn btn-maroon w-100">
                    <i class="bi bi-arrow-right"></i> Open Prediction Tool
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if team.elo_history and team.elo_history|length > 1 %}
const ctx = document.getElementById('eloChart').getContext('2d');
const eloData = {{ team.elo_history | tojson }};
const labels = eloData.map((d, i) => {
    if (i === 0) return 'Start';
    const opp = d.opponent_name || '?';
    const change = d.rating_change > 0 ? '+' + d.rating_change.toFixed(0) : d.rating_change.toFixed(0);
    return opp + ' (' + change + ')';
});
const ratings = eloData.map(d => d.rating);
const minR = Math.min(...ratings);
const maxR = Math.max(...ratings);
const padding = 30;

new Chart(ctx, {
    type: 'line',
    data: {
        labels: labels,
        datasets: [{
            label: 'Elo Rating',
            data: ratings,
            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--maroon').trim() || '#5D1725',
            backgroundColor: 'rgba(93, 23, 37, 0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 4,
            pointHoverRadius: 6,
            pointBackgroundColor: ratings.map((r, i) => {
                if (i === 0) return '#6c757d';
                return eloData[i].rating_change >= 0 ? '#198754' : '#dc3545';
            })
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: { display: false },
            tooltip: {
                callbacks: {
                    label: function(context) {
                        const d = eloData[context.dataIndex];
                        let label = 'Elo: ' + d.rating.toFixed(0);
                        if (d.rating_change) {
                            label += ' (' + (d.rating_change > 0 ? '+' : '') + d.rating_change.toFixed(1) + ')';
                        }
                        return label;
                    },
                    afterLabel: function(context) {
                        const d = eloData[context.dataIndex];
                        if (d.game_date && d.opponent_name !== 'Start') {
                            return 'vs ' + d.opponent_name + ' • ' + d.game_date;
                        }
                        return '';
                    }
                }
            }
        },
        scales: {
            x: {
                ticks: { 
                    maxRotation: 45,
                    autoSkip: true,
                    maxTicksLimit: 15,
                    font: { size: 10 }
                }
            },
            y: {
                min: Math.floor((minR - padding) / 10) * 10,
                max: Math.ceil((maxR + padding) / 10) * 10
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
