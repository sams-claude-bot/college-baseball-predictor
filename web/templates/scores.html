{% extends "base.html" %}

{% block title %}Scores & Schedule - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-clipboard-check"></i> Scores & Schedule
        {% if live_with_stats or live_espn_only %}
        <span id="live-indicator" class="badge bg-success ms-2" style="font-size: 0.6rem; vertical-align: middle; animation: pulse 2s infinite;">
            üî¥ LIVE
        </span>
        {% endif %}
    </h1>
    <div class="filter-bar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="filterGames('all')" id="filter-all">All Games</button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterGames('ranked')" id="filter-ranked">‚≠ê Top 25</button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterGames('gqi')" id="filter-gqi">Top Games</button>
        </div>
        <select class="form-select" id="conferenceFilter" onchange="updateFilters()">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Date Navigation -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/scores?date={{ prev_date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Prev
                </a>
            </div>
            <div class="col text-center">
                <h4 class="mb-1">{{ display_date.strftime('%A, %B %d, %Y') }}</h4>
                <div class="d-flex justify-content-center gap-4 text-muted flex-wrap">
                    <span><strong>{{ total_completed }}</strong> completed</span>
                    {% if total_scheduled > 0 %}
                    <span class="text-primary"><strong>{{ total_scheduled }}</strong> scheduled</span>
                    {% endif %}
                    {% if accuracy_pct is not none %}
                    <span class="{% if accuracy_pct >= 55 %}text-success{% elif accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>Ens: {{ correct_count }}/{{ total_preds }}</strong> ({{ accuracy_pct }}%)
                    </span>
                    {% endif %}
                    {% if nn_accuracy_pct is not none %}
                    <span class="{% if nn_accuracy_pct >= 55 %}text-success{% elif nn_accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>NN: {{ nn_correct }}/{{ nn_total }}</strong> ({{ nn_accuracy_pct }}%)
                    </span>
                    {% endif %}
                    {% if totals_accuracy_pct is not none %}
                    <span class="{% if totals_accuracy_pct >= 55 %}text-success{% elif totals_accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>O/U: {{ totals_correct }}/{{ totals_total }}</strong> ({{ totals_accuracy_pct }}%)
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-auto">
                <a href="/scores?date={{ next_date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
                   class="btn btn-outline-secondary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        
        <!-- Date picker -->
        <div class="row mt-3 justify-content-center">
            <div class="col-auto">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    <input type="date" class="form-control" id="datePicker" value="{{ selected_date }}"
                           onchange="goToDate(this.value)">
                    <button class="btn btn-maroon" onclick="goToDate(document.getElementById('datePicker').value)">
                        Go
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Date Links -->
<div class="mb-4 text-center">
    <span class="text-muted me-2">Recent dates:</span>
    {% for date_info in available_dates[:7] %}
    {% if date_info.completed > 0 %}
    <a href="/scores?date={{ date_info.date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
       class="btn btn-sm {% if date_info.date == selected_date %}btn-maroon{% else %}btn-outline-secondary{% endif %} me-1 mb-1">
        {{ date_info.date[5:] }} ({{ date_info.completed }})
    </a>
    {% endif %}
    {% endfor %}
</div>

<!-- Summary Stats -->
{% if total_completed > 0 %}
<div class="row mb-4">
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ total_completed }}</div>
            <div class="stat-label">Games Completed</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ avg_runs }}</div>
            <div class="stat-label">Avg Total Runs</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ home_win_pct }}%</div>
            <div class="stat-label">Home Win %</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value {% if upsets > 0 %}text-warning{% endif %}">{{ upsets }}</div>
            <div class="stat-label">Upsets</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Live Games with StatBroadcast Stats -->
{% if live_with_stats %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #198754; color: white;">
        <i class="bi bi-broadcast"></i> Live
        <span class="badge bg-light text-dark ms-2">{{ live_with_stats|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in live_with_stats %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-game-id="{{ game.id }}" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}" data-gqi="{{ game.gqi }}">
                <div class="border border-success rounded p-3 h-100"
                     style="cursor:pointer; background: rgba(25,135,84,0.08);"
                     onclick="window.location='/game/{{ game.id }}'">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {% if game.time %}{{ game.time }}{% endif %}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <div class="d-flex gap-1">
                            <span class="badge" style="background-color:{{ game.gqi_color }};font-size:.65rem" title="{{ game.gqi_label }}">GQI {{ game.gqi }}</span>
                        </div>
                    </div>
                    
                    <!-- R/H/E header -->
                    {% if game.away_hits is not none or game.home_hits is not none %}
                    <div class="d-flex justify-content-end mb-1">
                        <small class="text-muted" style="font-size:0.65rem; letter-spacing:0.5px;">
                            <span style="width:28px;display:inline-block;text-align:center;">R</span>
                            <span style="width:28px;display:inline-block;text-align:center;">H</span>
                            <span style="width:28px;display:inline-block;text-align:center;">E</span>
                        </small>
                    </div>
                    {% endif %}

                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fs-5 fw-bold live-away-score" style="width:28px;text-align:center;">{{ game.away_score }}</span>
                            {% if game.away_hits is not none %}
                            <span class="text-muted ms-1" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.away_hits }}</span>
                            <span class="text-muted" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.away_errors or 0 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="fs-5 fw-bold live-home-score" style="width:28px;text-align:center;">{{ game.home_score }}</span>
                            {% if game.home_hits is not none %}
                            <span class="text-muted ms-1" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.home_hits }}</span>
                            <span class="text-muted" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.home_errors or 0 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Live situation (runners, count, pitcher/batter) -->
                    {% if game.situation %}
                    {# Prefer StatBroadcast data (sb_*) over ESPN when available #}
                    {% set sit = game.situation %}
                    {% set s_outs = sit.get('sb_outs') if sit.get('sb_outs') is not none else sit.get('outs') %}
                    {% set s_balls = sit.get('sb_balls') if sit.get('sb_balls') is not none else sit.get('balls') %}
                    {% set s_strikes = sit.get('sb_strikes') if sit.get('sb_strikes') is not none else sit.get('strikes') %}
                    {% set s_count = sit.get('sb_count') or (s_balls|string ~ '-' ~ s_strikes|string if s_balls is not none else none) %}
                    {% set s_pitcher = sit.get('sb_pitcher') or sit.get('pitcher') %}
                    {% set s_batter = sit.get('sb_batter') or sit.get('batter') %}
                    {% set s_batter_pos = sit.get('sb_batter_position') %}
                    {% set has_situation = s_outs is not none or s_pitcher or s_batter %}
                    {% if has_situation %}
                    <div class="mt-2 pt-2 border-top d-flex justify-content-between align-items-center situation-panel" data-game-id="{{ game.id }}">
                        <div class="d-flex align-items-center gap-2">
                            <!-- Base diamond (prefer SB base runner data over ESPN) -->
                            {% set on_1b = sit.get('sb_on_first') if sit.get('sb_on_first') is not none else sit.get('onFirst') %}
                            {% set on_2b = sit.get('sb_on_second') if sit.get('sb_on_second') is not none else sit.get('onSecond') %}
                            {% set on_3b = sit.get('sb_on_third') if sit.get('sb_on_third') is not none else sit.get('onThird') %}
                            <svg width="32" height="32" viewBox="0 0 40 40" style="flex-shrink:0;">
                                <rect x="13" y="3" width="14" height="14" rx="1" transform="rotate(45 20 10)" 
                                      fill="{{ '#fbbf24' if on_2b else '#374151' }}" stroke="#6b7280" stroke-width="1.5" class="base-second"/>
                                <rect x="23" y="13" width="14" height="14" rx="1" transform="rotate(45 30 20)" 
                                      fill="{{ '#fbbf24' if on_1b else '#374151' }}" stroke="#6b7280" stroke-width="1.5" class="base-first"/>
                                <rect x="3" y="13" width="14" height="14" rx="1" transform="rotate(45 10 20)" 
                                      fill="{{ '#fbbf24' if on_3b else '#374151' }}" stroke="#6b7280" stroke-width="1.5" class="base-third"/>
                            </svg>
                            <!-- Outs + Count -->
                            <div>
                                {% if s_outs is not none %}
                                <span style="font-size:0.7rem;" class="text-muted sit-outs">
                                    {% for i in range(3) %}
                                    <span class="out-dot" style="color:{{ '#fbbf24' if i < s_outs else '#374151' }};">‚óè</span>
                                    {% endfor %}
                                </span>
                                {% endif %}
                                {% if s_count %}
                                <small class="text-muted d-block sit-count" style="font-size:0.65rem;">{{ s_count }}</small>
                                {% endif %}
                            </div>
                        </div>
                        <!-- Pitcher/Batter -->
                        <div class="text-end" style="font-size:0.7rem;">
                            {% if s_pitcher %}
                            <div class="text-muted sit-pitcher">P: {{ s_pitcher }}</div>
                            {% endif %}
                            {% if s_batter %}
                            <div class="text-muted sit-batter">AB: {{ s_batter }}{% if s_batter_pos %} <span class="text-muted" style="opacity:0.6;">[{{ s_batter_pos }}]</span>{% endif %}</div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                    {% endif %}

                    <!-- Per-inning linescore -->
                    {% if game.situation and game.situation.get('sb_visitor_innings') %}
                    {% set vis_inn = game.situation.get('sb_visitor_innings', []) %}
                    {% set hom_inn = game.situation.get('sb_home_innings', []) %}
                    {% set max_inn = [vis_inn|length, hom_inn|length]|max %}
                    {% if max_inn > 0 %}
                    <div class="mt-2 pt-2 border-top">
                        <table class="w-100" style="font-size:0.65rem; font-family:monospace;">
                            <thead>
                                <tr class="text-muted">
                                    <th style="width:40px;"></th>
                                    {% for i in range(max_inn) %}
                                    <th style="width:18px;text-align:center;padding:0 1px;">{{ i + 1 }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td class="text-muted" style="font-size:0.6rem;">{{ game.away_team_id[:4]|upper }}</td>
                                    {% for i in range(max_inn) %}
                                    <td style="text-align:center;padding:0 1px;{% if vis_inn[i] is defined and vis_inn[i] is number and vis_inn[i] > 0 %}color:#fbbf24;font-weight:bold;{% endif %}">{{ vis_inn[i] if vis_inn[i] is defined else '' }}</td>
                                    {% endfor %}
                                </tr>
                                <tr>
                                    <td class="text-muted" style="font-size:0.6rem;">{{ game.home_team_id[:4]|upper }}</td>
                                    {% for i in range(max_inn) %}
                                    <td style="text-align:center;padding:0 1px;{% if hom_inn[i] is defined and hom_inn[i] is number and hom_inn[i] > 0 %}color:#fbbf24;font-weight:bold;{% endif %}">{{ hom_inn[i] if hom_inn[i] is defined else '' }}</td>
                                    {% endfor %}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- Pre-game predictions -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-success fw-bold live-inning">{{ game.inning_text or 'In Progress' }}</small>
                            <div class="d-flex gap-2">
                                {% if game.pred_winner %}
                                {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                                <small class="text-muted" title="Pre-game ensemble">
                                    Ens: {{ ens_pct }}% {{ game.home_team_name if game.pred_winner == game.home_team_id else game.away_team_name }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Live Games (ESPN only, no StatBroadcast) -->
{% if live_espn_only %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #6c757d; color: white;">
        <i class="bi bi-broadcast"></i> Live <small class="opacity-75">‚Äî ESPN only</small>
        <span class="badge bg-light text-dark ms-2">{{ live_espn_only|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in live_espn_only %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-game-id="{{ game.id }}" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}" data-gqi="{{ game.gqi }}">
                <div class="border rounded p-3 h-100"
                     style="cursor:pointer; background: rgba(108,117,125,0.08);"
                     onclick="window.location='/game/{{ game.id }}'">

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {% if game.time %}{{ game.time }}{% endif %}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <div class="d-flex gap-1">
                            <span class="badge" style="background-color:{{ game.gqi_color }};font-size:.65rem" title="{{ game.gqi_label }}">GQI {{ game.gqi }}</span>
                        </div>
                    </div>

                    {% if game.away_hits is not none or game.home_hits is not none %}
                    <div class="d-flex justify-content-end mb-1">
                        <small class="text-muted" style="font-size:0.65rem; letter-spacing:0.5px;">
                            <span style="width:28px;display:inline-block;text-align:center;">R</span>
                            <span style="width:28px;display:inline-block;text-align:center;">H</span>
                            <span style="width:28px;display:inline-block;text-align:center;">E</span>
                        </small>
                    </div>
                    {% endif %}

                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            {% if game.away_logo %}<img src="{{ game.away_logo }}" alt="" width="20" height="20" class="me-1">{% endif %}
                            <span class="{% if game.away_rank %}fw-bold{% endif %}">
                                {% if game.away_rank %}<small class="text-muted">{{ game.away_rank }}</small> {% endif %}
                                {{ game.away_team_name }}
                            </span>
                        </div>
                        <div class="d-flex align-items-center">
                            <strong class="live-away-score">{{ game.away_score if game.away_score is not none else '-' }}</strong>
                            {% if game.away_hits is not none %}
                            <span class="text-muted ms-1" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.away_hits }}</span>
                            <span class="text-muted" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.away_errors or 0 }}</span>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if game.home_logo %}<img src="{{ game.home_logo }}" alt="" width="20" height="20" class="me-1">{% endif %}
                            <span class="{% if game.home_rank %}fw-bold{% endif %}">
                                {% if game.home_rank %}<small class="text-muted">{{ game.home_rank }}</small> {% endif %}
                                {{ game.home_team_name }}
                            </span>
                        </div>
                        <div class="d-flex align-items-center">
                            <strong class="live-home-score">{{ game.home_score if game.home_score is not none else '-' }}</strong>
                            {% if game.home_hits is not none %}
                            <span class="text-muted ms-1" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.home_hits }}</span>
                            <span class="text-muted" style="width:28px;text-align:center;font-size:0.85rem;">{{ game.home_errors or 0 }}</span>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Inning + prediction -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-success fw-bold live-inning">{{ game.inning_text or 'In Progress' }}</small>
                            <div class="d-flex gap-2">
                                {% if game.pred_winner %}
                                {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                                <small class="text-muted" title="Pre-game ensemble">
                                    Ens: {{ ens_pct }}% {{ game.home_team_name if game.pred_winner == game.home_team_id else game.away_team_name }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Scheduled Games -->
{% if scheduled_games %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-clock"></i> Scheduled
        <span class="badge bg-secondary ms-2">{{ scheduled_games|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in scheduled_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-game-id="{{ game.id }}" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}" data-gqi="{{ game.gqi }}">
                <div class="border rounded p-3 h-100"
                     style="cursor:pointer;"
                     onclick="window.location='/game/{{ game.id }}'">

                    <!-- Game header -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {{ game.time or 'TBD' }}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <div class="d-flex gap-1">
                            <span class="badge" style="background-color:{{ game.gqi_color }};font-size:.65rem" title="{{ game.gqi_label }}">GQI {{ game.gqi }}</span>
                            <span class="badge bg-primary">Scheduled</span>
                        </div>
                    </div>
                    
                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        {% if game.away_ml %}
                        <small class="text-muted">{{ game.away_ml|format_odds }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        {% if game.home_ml %}
                        <small class="text-muted">{{ game.home_ml|format_odds }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Model predictions footer -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
                            <!-- Ensemble prediction -->
                            {% if game.pred_winner and game.home_team_name and game.away_team_name %}
                            {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                            {% set ens_pick = game.home_team_name if game.pred_winner == game.home_team_id else game.away_team_name %}
                            <span class="badge bg-secondary" title="Ensemble picks {{ ens_pick }}">
                                <strong>Ens:</strong> {{ ens_pick[:10] }} {{ ens_pct }}%
                            </span>
                            {% endif %}
                            
                            <!-- Neural prediction -->
                            {% if game.nn_winner and game.home_team_name and game.away_team_name %}
                            {% set nn_pct = (game.nn_confidence * 100)|round(0)|int %}
                            {% set nn_pick = game.home_team_name if game.nn_winner == game.home_team_id else game.away_team_name %}
                            <span class="badge bg-info" title="Neural picks {{ nn_pick }}">
                                <strong>NN:</strong> {{ nn_pick[:10] }} {{ nn_pct }}%
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Projected totals/margin -->
                        <div class="d-flex justify-content-between mt-1 flex-wrap gap-1">
                            {% if game.over_under %}
                            <small class="text-muted">O/U: {{ game.over_under }}</small>
                            {% endif %}
                            {% if game.nn_projected_total %}
                            <small class="{% if game.over_under and game.nn_projected_total > game.over_under %}text-success{% elif game.over_under and game.nn_projected_total < game.over_under %}text-danger{% else %}text-muted{% endif %}"
                                   title="Projected total">
                                Proj: {{ game.nn_projected_total|round(1) }}
                            </small>
                            {% endif %}
                            {% if game.nn_projected_margin is defined and game.nn_projected_margin is not none %}
                            <small class="text-muted" title="Projected home margin">
                                Margin: {{ '%+.1f'|format(game.nn_projected_margin) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Completed Games -->
{% if completed_games %}
<div class="card mb-4">
    <div class="card-header bg-maroon text-white">
        <i class="bi bi-check-circle"></i> Final Scores
        <span class="badge bg-light text-dark ms-2">{{ completed_games|length }}</span>
        {% if accuracy_pct is not none %}
        <span class="badge {% if accuracy_pct >= 55 %}bg-success{% elif accuracy_pct >= 50 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
            Ens {{ accuracy_pct }}%
        </span>
        {% endif %}
        {% if nn_accuracy_pct is not none %}
        <span class="badge {% if nn_accuracy_pct >= 55 %}bg-success{% elif nn_accuracy_pct >= 50 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
            NN {{ nn_accuracy_pct }}%
        </span>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in completed_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-game-id="{{ game.id }}" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}" data-gqi="{{ game.gqi }}">
                <div class="border rounded p-3 h-100 {% if game.is_upset %}border-warning{% endif %}"
                     style="cursor:pointer; {% if game.is_upset %}background: rgba(255,193,7,0.1);{% endif %}"
                     onclick="window.location='/game/{{ game.id }}'">

                    <!-- Game header with time/status -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {% if game.time %}{{ game.time }}{% endif %}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <div class="d-flex gap-1">
                            <span class="badge" style="background-color:{{ game.gqi_color }};font-size:.65rem" title="{{ game.gqi_label }}">GQI {{ game.gqi }}</span>
                            {% if game.pred_correct is not none %}
                                {% if game.pred_correct %}
                                <span class="badge bg-success" title="Prediction correct"><i class="bi bi-check"></i> ‚úÖ</span>
                                {% else %}
                                <span class="badge bg-danger" title="Prediction wrong"><i class="bi bi-x"></i> ‚ùå</span>
                                {% endif %}
                            {% endif %}
                            {% if game.is_upset %}
                            <span class="badge bg-warning text-dark" title="Upset!">‚ö°</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1 {% if game.winner_id == game.away_team_id %}fw-bold{% endif %}">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link {% if game.winner_id == game.away_team_id %}text-success{% endif %}" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 {% if game.winner_id == game.away_team_id %}text-success fw-bold{% endif %}">
                            {{ game.away_score }}
                        </span>
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center {% if game.winner_id == game.home_team_id %}fw-bold{% endif %}">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link {% if game.winner_id == game.home_team_id %}text-success{% endif %}" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 {% if game.winner_id == game.home_team_id %}text-success fw-bold{% endif %}">
                            {{ game.home_score }}
                        </span>
                    </div>
                    
                    <!-- Model predictions footer -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {% if game.innings and game.innings != 9 %}({{ game.innings }} inn) {% endif %}Final
                            </small>
                            <div class="d-flex gap-2">
                                <!-- Ensemble prediction -->
                                {% if game.pred_winner %}
                                {% set ens_picked_winner = game.pred_winner == game.winner_id %}
                                {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                                <small class="{% if ens_picked_winner %}text-success{% else %}text-danger{% endif %}" 
                                       title="Ensemble: picked {{ 'home' if game.pred_winner == game.home_team_id else 'away' }} at {{ ens_pct }}%">
                                    Ens: {{ ens_pct }}% {% if ens_picked_winner %}‚úì{% else %}‚úó{% endif %}
                                </small>
                                {% endif %}
                                
                                <!-- Neural prediction -->
                                {% if game.nn_winner %}
                                {% set nn_picked_winner = game.nn_winner == game.winner_id %}
                                {% set nn_pct = (game.nn_confidence * 100)|round(0)|int %}
                                <small class="{% if nn_picked_winner %}text-success{% else %}text-danger{% endif %}"
                                       title="Neural: picked {{ 'home' if game.nn_winner == game.home_team_id else 'away' }} at {{ nn_pct }}%">
                                    NN: {{ nn_pct }}% {% if nn_picked_winner %}‚úì{% else %}‚úó{% endif %}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Betting lines & totals if available -->
                        {% if game.over_under or game.nn_projected_total %}
                        <div class="d-flex justify-content-between mt-1">
                            {% if game.over_under %}
                            <small class="text-muted">O/U: {{ game.over_under }}</small>
                            {% endif %}
                            {% if game.nn_projected_total %}
                            <small class="text-muted">Proj: {{ game.nn_projected_total|round(1) }}</small>
                            {% endif %}
                            {% set actual_total = (game.home_score or 0) + (game.away_score or 0) %}
                            <small class="text-muted">Actual: {{ actual_total }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Postponed/Canceled Games -->
{% if postponed_games is defined and postponed_games %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-x-circle"></i> Postponed / Canceled
        <span class="badge bg-warning text-dark ms-2">{{ postponed_games|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in postponed_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-game-id="{{ game.id }}" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}">
                <div class="border rounded p-3 h-100 opacity-50">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">{{ game.time or 'TBD' }}</small>
                        <span class="badge bg-warning text-dark">{{ game.status|capitalize }}</span>
                    </div>
                    <div class="mb-1">
                        {% if game.away_rank %}<span class="badge bg-maroon me-1">{{ game.away_rank }}</span>{% endif %}
                        <a href="/team/{{ game.away_team_id }}" class="team-link">{{ game.away_team_name }}</a>
                    </div>
                    <div>
                        {% if game.home_rank %}<span class="badge bg-maroon me-1">{{ game.home_rank }}</span>{% endif %}
                        <a href="/team/{{ game.home_team_id }}" class="team-link">{{ game.home_team_name }}</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- No Games Found -->
{% if not completed_games and not live_with_stats and not live_espn_only and not scheduled_games %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x display-1 text-muted"></i>
        <h4 class="mt-3">No Games Found</h4>
        <p class="text-muted">
            No games on {{ display_date.strftime('%B %d, %Y') }}
            {% if selected_conference %}in {{ selected_conference }}{% endif %}
        </p>
        <a href="/scores?date={{ prev_date }}" class="btn btn-maroon">
            <i class="bi bi-chevron-left"></i> Check Previous Day
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
function goToDate(dateStr) {
    const conf = document.getElementById('conferenceFilter').value;
    let url = '/scores?date=' + dateStr;
    if (conf) {
        url += '&conference=' + encodeURIComponent(conf);
    }
    window.location.href = url;
}

function updateFilters() {
    const date = '{{ selected_date }}';
    goToDate(date);
}

function filterGames(mode) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    document.getElementById('filter-' + mode).classList.add('active');

    const cards = document.querySelectorAll('.game-card');
    let visibleCount = 0;

    cards.forEach(card => {
        if (mode === 'ranked') {
            const isRanked = card.dataset.ranked === 'true';
            card.style.display = isRanked ? '' : 'none';
            if (isRanked) visibleCount++;
        } else {
            card.style.display = '';
            visibleCount++;
        }
    });

    // Sort within each section
    document.querySelectorAll('.row.g-0').forEach(row => {
        const gameCards = Array.from(row.querySelectorAll('.game-card'));
        if (gameCards.length === 0) return;

        if (mode === 'gqi') {
            // Sort by GQI descending
            gameCards.sort((a, b) => parseFloat(b.dataset.gqi || 0) - parseFloat(a.dataset.gqi || 0));
        } else {
            // Sort ranked games to top
            gameCards.sort((a, b) => {
                const aRanked = a.dataset.ranked === 'true';
                const bRanked = b.dataset.ranked === 'true';
                if (aRanked && !bRanked) return -1;
                if (!aRanked && bRanked) return 1;
                const aRank = Math.min(parseInt(a.dataset.homeRank) || 999, parseInt(a.dataset.awayRank) || 999);
                const bRank = Math.min(parseInt(b.dataset.homeRank) || 999, parseInt(b.dataset.awayRank) || 999);
                return aRank - bRank;
            });
        }

        gameCards.forEach(card => row.appendChild(card));
    });

    // Hide empty sections
    document.querySelectorAll('.card.mb-4').forEach(section => {
        const visCards = section.querySelectorAll('.game-card:not([style*="display: none"])');
        if (section.querySelector('.game-card')) {
            section.style.display = visCards.length > 0 ? '' : 'none';
        }
    });
}

// Sort ranked games to top on initial load
document.addEventListener('DOMContentLoaded', () => filterGames('all'));

// ‚îÄ‚îÄ‚îÄ Live Score Updates (SSE + polling fallback) ‚îÄ‚îÄ‚îÄ
(function() {
    const POLL_INTERVAL = 60000; // 60 seconds
    const ACTIVE_DATE = '{{ selected_date }}';
    let pollTimer = null;
    let hasLive = {{ 'true' if live_with_stats or live_espn_only else 'false' }};
    let consecutiveErrors = 0;
    let evtSource = null;

    // ‚îÄ‚îÄ Shared card updater ‚îÄ‚îÄ
    function updateGameCard(data) {
        const card = document.querySelector('.game-card[data-game-id="' + data.game_id + '"]');
        if (!card) return;

        const awayScore = card.querySelector('.live-away-score');
        const homeScore = card.querySelector('.live-home-score');
        const inning = card.querySelector('.live-inning');

        if (awayScore && data.away_score !== null && data.away_score !== undefined) {
            if (awayScore.textContent.trim() !== String(data.away_score)) {
                awayScore.textContent = data.away_score;
                awayScore.style.transition = 'color 0.3s';
                awayScore.style.color = '#198754';
                setTimeout(function() { awayScore.style.color = ''; }, 2000);
            }
        }
        if (homeScore && data.home_score !== null && data.home_score !== undefined) {
            if (homeScore.textContent.trim() !== String(data.home_score)) {
                homeScore.textContent = data.home_score;
                homeScore.style.transition = 'color 0.3s';
                homeScore.style.color = '#198754';
                setTimeout(function() { homeScore.style.color = ''; }, 2000);
            }
        }
        if (inning && data.inning_text) {
            inning.textContent = data.inning_text;
        }

        // Update situation panel if data available
        if (data.situation) {
            var sit = data.situation;
            var panel = card.querySelector('.situation-panel');

            // Prefer sb_ fields over ESPN
            var outs = sit.sb_outs !== undefined && sit.sb_outs !== null ? sit.sb_outs : sit.outs;
            var balls = sit.sb_balls !== undefined && sit.sb_balls !== null ? sit.sb_balls : sit.balls;
            var strikes = sit.sb_strikes !== undefined && sit.sb_strikes !== null ? sit.sb_strikes : sit.strikes;
            var pitcher = sit.sb_pitcher || sit.pitcher || '';
            var batter = sit.sb_batter || sit.batter || '';
            var batter_pos = sit.sb_batter_position || '';

            if (panel) {
                // Update outs dots
                var dots = panel.querySelectorAll('.out-dot');
                if (dots.length === 3 && outs !== null && outs !== undefined) {
                    for (var i = 0; i < 3; i++) {
                        dots[i].style.color = i < outs ? '#fbbf24' : '#374151';
                    }
                }

                // Update count
                var countEl = panel.querySelector('.sit-count');
                if (countEl && balls !== null && balls !== undefined) {
                    countEl.textContent = balls + '-' + strikes;
                }

                // Update pitcher
                var pitcherEl = panel.querySelector('.sit-pitcher');
                if (pitcher) {
                    if (pitcherEl) {
                        pitcherEl.textContent = 'P: ' + pitcher;
                    }
                }

                // Update batter
                var batterEl = panel.querySelector('.sit-batter');
                if (batter) {
                    var batterText = 'AB: ' + batter;
                    if (batter_pos) batterText += ' [' + batter_pos + ']';
                    if (batterEl) {
                        batterEl.textContent = batterText;
                    }
                }

                // Update base diamond SVG
                var on1 = sit.sb_on_first !== undefined && sit.sb_on_first !== null ? sit.sb_on_first : sit.onFirst;
                var on2 = sit.sb_on_second !== undefined && sit.sb_on_second !== null ? sit.sb_on_second : sit.onSecond;
                var on3 = sit.sb_on_third !== undefined && sit.sb_on_third !== null ? sit.sb_on_third : sit.onThird;
                var base1 = panel.querySelector('.base-first');
                var base2 = panel.querySelector('.base-second');
                var base3 = panel.querySelector('.base-third');
                if (base1) base1.setAttribute('fill', on1 ? '#fbbf24' : '#374151');
                if (base2) base2.setAttribute('fill', on2 ? '#fbbf24' : '#374151');
                if (base3) base3.setAttribute('fill', on3 ? '#fbbf24' : '#374151');
            }
        }
    }

    // ‚îÄ‚îÄ EventSource (SSE) ‚îÄ‚îÄ
    function startSSE() {
        if (evtSource) return;
        if (typeof EventSource === 'undefined') { startPolling(); return; }

        evtSource = new EventSource('/api/live-stream');

        evtSource.addEventListener('score_update', function(e) {
            var data = JSON.parse(e.data);
            updateGameCard(data);
        });

        evtSource.addEventListener('status_change', function(e) {
            var data = JSON.parse(e.data);
            if (data.status === 'final') {
                setTimeout(function() { window.location.reload(); }, 3000);
            } else {
                updateGameCard(data);
            }
        });

        evtSource.addEventListener('game_final', function(e) {
            setTimeout(function() { window.location.reload(); }, 3000);
        });

        evtSource.addEventListener('situation_update', function(e) {
            var data = JSON.parse(e.data);
            updateGameCard(data);
        });

        evtSource.addEventListener('sb_situation', function(e) {
            var raw = JSON.parse(e.data);
            if (!raw.game_id) return;
            // Map SB situation fields to the format updateGameCard expects
            updateGameCard({
                game_id: raw.game_id,
                home_score: raw.home_score,
                away_score: raw.visitor_score,
                inning_text: (raw.inning_half === 'top' ? 'Top ' : raw.inning_half === 'bottom' ? 'Bot ' : '') + (raw.inning || ''),
                situation: {
                    sb_outs: raw.outs,
                    sb_balls: raw.count ? parseInt(raw.count.split('-')[0]) : null,
                    sb_strikes: raw.count ? parseInt(raw.count.split('-')[1]) : null,
                    sb_pitcher: raw.pitcher,
                    sb_batter: raw.batter,
                    sb_on_first: raw.on_first,
                    sb_on_second: raw.on_second,
                    sb_on_third: raw.on_third
                }
            });
        });

        evtSource.onerror = function() {
            console.log('SSE connection lost, falling back to polling');
            stopSSE();
            startPolling();
        };

        console.log('SSE live stream connected');
    }

    function stopSSE() {
        if (evtSource) {
            evtSource.close();
            evtSource = null;
        }
    }

    // ‚îÄ‚îÄ Polling fallback ‚îÄ‚îÄ
    function updateLiveScores() {
        fetch('/api/live-scores?date=' + ACTIVE_DATE)
            .then(function(r) { return r.json(); })
            .then(function(data) {
                consecutiveErrors = 0;

                document.querySelectorAll('.game-card[data-game-id]').forEach(function(card) {
                    var gameId = card.dataset.gameId;
                    var game = data.games[gameId];
                    if (!game) return;

                    updateGameCard({
                        game_id: gameId,
                        home_score: game.home_score,
                        away_score: game.away_score,
                        inning_text: game.inning_text,
                        status: game.status,
                        situation: game.situation
                    });

                    if (game.status === 'final' && card.closest('.card') && card.closest('.card').querySelector('.bi-broadcast')) {
                        setTimeout(function() { window.location.reload(); }, 3000);
                    }
                });

                var liveIndicator = document.getElementById('live-indicator');
                if (data.has_live) {
                    if (liveIndicator) liveIndicator.style.display = '';
                } else {
                    if (liveIndicator) liveIndicator.style.display = 'none';
                    if (hasLive && !data.has_live) {
                        setTimeout(function() { window.location.reload(); }, 3000);
                        return;
                    }
                    stopPolling();
                }
                hasLive = data.has_live;
            })
            .catch(function() {
                consecutiveErrors++;
                if (consecutiveErrors > 3) stopPolling();
            });
    }

    function startPolling() {
        if (pollTimer) return;
        pollTimer = setInterval(updateLiveScores, POLL_INTERVAL);
        console.log('Live score polling started (60s)');
    }

    function stopPolling() {
        if (pollTimer) {
            clearInterval(pollTimer);
            pollTimer = null;
            console.log('Live score polling stopped');
        }
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    if (hasLive) {
        startSSE();
        // Immediate poll as fallback for stale page data
        setTimeout(updateLiveScores, 5000);
    }

    // During game hours, check for newly live games
    var hour = new Date().getHours();
    if (hour >= 11 && hour <= 23 && ACTIVE_DATE === new Date().toISOString().slice(0,10)) {
        if (!hasLive) {
            pollTimer = setInterval(function() {
                fetch('/api/live-scores?date=' + ACTIVE_DATE)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.has_live) {
                            window.location.reload();
                        }
                    })
                    .catch(function() {});
            }, 300000);
        }
    }
})();
</script>
{% endblock %}
