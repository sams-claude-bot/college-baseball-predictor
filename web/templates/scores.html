{% extends "base.html" %}

{% block title %}Scores & Schedule - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">
        <i class="bi bi-clipboard-check"></i> Scores & Schedule
    </h1>
    <div class="filter-bar">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-secondary active" onclick="filterGames('all')" id="filter-all">All Games</button>
            <button type="button" class="btn btn-outline-secondary" onclick="filterGames('ranked')" id="filter-ranked">⭐ Top 25</button>
        </div>
        <select class="form-select" id="conferenceFilter" onchange="updateFilters()">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<!-- Date Navigation -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-auto">
                <a href="/scores?date={{ prev_date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
                   class="btn btn-outline-secondary">
                    <i class="bi bi-chevron-left"></i> Prev
                </a>
            </div>
            <div class="col text-center">
                <h4 class="mb-1">{{ display_date.strftime('%A, %B %d, %Y') }}</h4>
                <div class="d-flex justify-content-center gap-4 text-muted flex-wrap">
                    <span><strong>{{ total_completed }}</strong> completed</span>
                    {% if total_scheduled > 0 %}
                    <span class="text-primary"><strong>{{ total_scheduled }}</strong> scheduled</span>
                    {% endif %}
                    {% if accuracy_pct is not none %}
                    <span class="{% if accuracy_pct >= 55 %}text-success{% elif accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>Ens: {{ correct_count }}/{{ total_preds }}</strong> ({{ accuracy_pct }}%)
                    </span>
                    {% endif %}
                    {% if nn_accuracy_pct is not none %}
                    <span class="{% if nn_accuracy_pct >= 55 %}text-success{% elif nn_accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>NN: {{ nn_correct }}/{{ nn_total }}</strong> ({{ nn_accuracy_pct }}%)
                    </span>
                    {% endif %}
                    {% if totals_accuracy_pct is not none %}
                    <span class="{% if totals_accuracy_pct >= 55 %}text-success{% elif totals_accuracy_pct >= 50 %}text-warning{% else %}text-danger{% endif %}">
                        <strong>O/U: {{ totals_correct }}/{{ totals_total }}</strong> ({{ totals_accuracy_pct }}%)
                    </span>
                    {% endif %}
                </div>
            </div>
            <div class="col-auto">
                <a href="/scores?date={{ next_date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
                   class="btn btn-outline-secondary">
                    Next <i class="bi bi-chevron-right"></i>
                </a>
            </div>
        </div>
        
        <!-- Date picker -->
        <div class="row mt-3 justify-content-center">
            <div class="col-auto">
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                    <input type="date" class="form-control" id="datePicker" value="{{ selected_date }}"
                           onchange="goToDate(this.value)">
                    <button class="btn btn-maroon" onclick="goToDate(document.getElementById('datePicker').value)">
                        Go
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Date Links -->
<div class="mb-4 text-center">
    <span class="text-muted me-2">Recent dates:</span>
    {% for date_info in available_dates[:7] %}
    {% if date_info.completed > 0 %}
    <a href="/scores?date={{ date_info.date }}{% if selected_conference %}&conference={{ selected_conference }}{% endif %}" 
       class="btn btn-sm {% if date_info.date == selected_date %}btn-maroon{% else %}btn-outline-secondary{% endif %} me-1 mb-1">
        {{ date_info.date[5:] }} ({{ date_info.completed }})
    </a>
    {% endif %}
    {% endfor %}
</div>

<!-- Summary Stats -->
{% if total_completed > 0 %}
<div class="row mb-4">
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ total_completed }}</div>
            <div class="stat-label">Games Completed</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ avg_runs }}</div>
            <div class="stat-label">Avg Total Runs</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value">{{ home_win_pct }}%</div>
            <div class="stat-label">Home Win %</div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card stat-card">
            <div class="stat-value {% if upsets > 0 %}text-warning{% endif %}">{{ upsets }}</div>
            <div class="stat-label">Upsets</div>
        </div>
    </div>
</div>
{% endif %}

<!-- In-Progress Games (moved above Final) -->
{% if in_progress_games %}
<div class="card mb-4">
    <div class="card-header" style="background-color: #198754; color: white;">
        <i class="bi bi-broadcast"></i> Live
        <span class="badge bg-light text-dark ms-2">{{ in_progress_games|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in in_progress_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}">
                <div class="border border-success rounded p-3 h-100" 
                     style="cursor:pointer; background: rgba(25,135,84,0.08);"
                     onclick="window.location='/game/{{ game.id }}'">
                    
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {% if game.time %}{{ game.time }}{% endif %}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <span class="badge bg-success">LIVE</span>
                    </div>
                    
                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 fw-bold">{{ game.away_score }}</span>
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 fw-bold">{{ game.home_score }}</span>
                    </div>
                    
                    <!-- Pre-game predictions -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-success fw-bold">{{ game.inning_text or 'In Progress' }}</small>
                            <div class="d-flex gap-2">
                                {% if game.pred_winner %}
                                {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                                <small class="text-muted" title="Pre-game ensemble">
                                    Ens: {{ ens_pct }}% {{ game.home_team_name if game.pred_winner == game.home_team_id else game.away_team_name }}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Scheduled Games -->
{% if scheduled_games %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-clock"></i> Scheduled
        <span class="badge bg-secondary ms-2">{{ scheduled_games|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in scheduled_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}">
                <div class="border rounded p-3 h-100" 
                     style="cursor:pointer;"
                     onclick="window.location='/game/{{ game.id }}'">
                    
                    <!-- Game header -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {{ game.time or 'TBD' }}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <span class="badge bg-primary">Scheduled</span>
                    </div>
                    
                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        {% if game.away_ml %}
                        <small class="text-muted">{{ game.away_ml|format_odds }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        {% if game.home_ml %}
                        <small class="text-muted">{{ game.home_ml|format_odds }}</small>
                        {% endif %}
                    </div>
                    
                    <!-- Model predictions footer -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-1">
                            <!-- Ensemble prediction -->
                            {% if game.pred_winner and game.home_team_name and game.away_team_name %}
                            {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                            {% set ens_pick = game.home_team_name if game.pred_winner == game.home_team_id else game.away_team_name %}
                            <span class="badge bg-secondary" title="Ensemble picks {{ ens_pick }}">
                                <strong>Ens:</strong> {{ ens_pick[:10] }} {{ ens_pct }}%
                            </span>
                            {% endif %}
                            
                            <!-- Neural prediction -->
                            {% if game.nn_winner and game.home_team_name and game.away_team_name %}
                            {% set nn_pct = (game.nn_confidence * 100)|round(0)|int %}
                            {% set nn_pick = game.home_team_name if game.nn_winner == game.home_team_id else game.away_team_name %}
                            <span class="badge bg-info" title="Neural picks {{ nn_pick }}">
                                <strong>NN:</strong> {{ nn_pick[:10] }} {{ nn_pct }}%
                            </span>
                            {% endif %}
                        </div>
                        
                        <!-- Projected totals/margin -->
                        <div class="d-flex justify-content-between mt-1 flex-wrap gap-1">
                            {% if game.over_under %}
                            <small class="text-muted">O/U: {{ game.over_under }}</small>
                            {% endif %}
                            {% if game.nn_projected_total %}
                            <small class="{% if game.over_under and game.nn_projected_total > game.over_under %}text-success{% elif game.over_under and game.nn_projected_total < game.over_under %}text-danger{% else %}text-muted{% endif %}"
                                   title="Projected total">
                                Proj: {{ game.nn_projected_total|round(1) }}
                            </small>
                            {% endif %}
                            {% if game.nn_projected_margin is defined and game.nn_projected_margin is not none %}
                            <small class="text-muted" title="Projected home margin">
                                Margin: {{ '%+.1f'|format(game.nn_projected_margin) }}
                            </small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Completed Games -->
{% if completed_games %}
<div class="card mb-4">
    <div class="card-header bg-maroon text-white">
        <i class="bi bi-check-circle"></i> Final Scores
        <span class="badge bg-light text-dark ms-2">{{ completed_games|length }}</span>
        {% if accuracy_pct is not none %}
        <span class="badge {% if accuracy_pct >= 55 %}bg-success{% elif accuracy_pct >= 50 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
            Ens {{ accuracy_pct }}%
        </span>
        {% endif %}
        {% if nn_accuracy_pct is not none %}
        <span class="badge {% if nn_accuracy_pct >= 55 %}bg-success{% elif nn_accuracy_pct >= 50 %}bg-warning{% else %}bg-danger{% endif %} ms-2">
            NN {{ nn_accuracy_pct }}%
        </span>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in completed_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}" data-home-rank="{{ game.home_rank or 999 }}" data-away-rank="{{ game.away_rank or 999 }}">
                <div class="border rounded p-3 h-100 {% if game.is_upset %}border-warning{% endif %}" 
                     style="cursor:pointer; {% if game.is_upset %}background: rgba(255,193,7,0.1);{% endif %}"
                     onclick="window.location='/game/{{ game.id }}'">
                    
                    <!-- Game header with time/status -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">
                            {% if game.time %}{{ game.time }}{% endif %}
                            {% if game.is_conference_game %}<span class="badge bg-secondary ms-1">Conf</span>{% endif %}
                        </small>
                        <div>
                            {% if game.pred_correct is not none %}
                                {% if game.pred_correct %}
                                <span class="badge bg-success" title="Prediction correct"><i class="bi bi-check"></i> ✅</span>
                                {% else %}
                                <span class="badge bg-danger" title="Prediction wrong"><i class="bi bi-x"></i> ❌</span>
                                {% endif %}
                            {% endif %}
                            {% if game.is_upset %}
                            <span class="badge bg-warning text-dark" title="Upset!">⚡</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Away team -->
                    <div class="d-flex justify-content-between align-items-center mb-1 {% if game.winner_id == game.away_team_id %}fw-bold{% endif %}">
                        <div class="d-flex align-items-center">
                            {% if game.away_rank %}
                            <span class="badge bg-maroon me-2">{{ game.away_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.away_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.away_team_id }}" class="team-link {% if game.winner_id == game.away_team_id %}text-success{% endif %}" onclick="event.stopPropagation();">
                                {{ game.away_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 {% if game.winner_id == game.away_team_id %}text-success fw-bold{% endif %}">
                            {{ game.away_score }}
                        </span>
                    </div>
                    
                    <!-- Home team -->
                    <div class="d-flex justify-content-between align-items-center {% if game.winner_id == game.home_team_id %}fw-bold{% endif %}">
                        <div class="d-flex align-items-center">
                            {% if game.home_rank %}
                            <span class="badge bg-maroon me-2">{{ game.home_rank }}</span>
                            {% endif %}
                            <img src="{{ team_logo(game.home_team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                            <a href="/team/{{ game.home_team_id }}" class="team-link {% if game.winner_id == game.home_team_id %}text-success{% endif %}" onclick="event.stopPropagation();">
                                {{ game.home_team_name }}
                            </a>
                        </div>
                        <span class="fs-5 {% if game.winner_id == game.home_team_id %}text-success fw-bold{% endif %}">
                            {{ game.home_score }}
                        </span>
                    </div>
                    
                    <!-- Model predictions footer -->
                    <div class="mt-2 pt-2 border-top">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                {% if game.innings and game.innings != 9 %}({{ game.innings }} inn) {% endif %}Final
                            </small>
                            <div class="d-flex gap-2">
                                <!-- Ensemble prediction -->
                                {% if game.pred_winner %}
                                {% set ens_picked_winner = game.pred_winner == game.winner_id %}
                                {% set ens_pct = (game.pred_confidence * 100)|round(0)|int %}
                                <small class="{% if ens_picked_winner %}text-success{% else %}text-danger{% endif %}" 
                                       title="Ensemble: picked {{ 'home' if game.pred_winner == game.home_team_id else 'away' }} at {{ ens_pct }}%">
                                    Ens: {{ ens_pct }}% {% if ens_picked_winner %}✓{% else %}✗{% endif %}
                                </small>
                                {% endif %}
                                
                                <!-- Neural prediction -->
                                {% if game.nn_winner %}
                                {% set nn_picked_winner = game.nn_winner == game.winner_id %}
                                {% set nn_pct = (game.nn_confidence * 100)|round(0)|int %}
                                <small class="{% if nn_picked_winner %}text-success{% else %}text-danger{% endif %}"
                                       title="Neural: picked {{ 'home' if game.nn_winner == game.home_team_id else 'away' }} at {{ nn_pct }}%">
                                    NN: {{ nn_pct }}% {% if nn_picked_winner %}✓{% else %}✗{% endif %}
                                </small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Betting lines & totals if available -->
                        {% if game.over_under or game.nn_projected_total %}
                        <div class="d-flex justify-content-between mt-1">
                            {% if game.over_under %}
                            <small class="text-muted">O/U: {{ game.over_under }}</small>
                            {% endif %}
                            {% if game.nn_projected_total %}
                            <small class="text-muted">Proj: {{ game.nn_projected_total|round(1) }}</small>
                            {% endif %}
                            {% set actual_total = (game.home_score or 0) + (game.away_score or 0) %}
                            <small class="text-muted">Actual: {{ actual_total }}</small>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Postponed/Canceled Games -->
{% if postponed_games is defined and postponed_games %}
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-x-circle"></i> Postponed / Canceled
        <span class="badge bg-warning text-dark ms-2">{{ postponed_games|length }}</span>
    </div>
    <div class="card-body p-0">
        <div class="row g-0">
            {% for game in postponed_games %}
            <div class="col-12 col-md-6 col-lg-4 p-2 game-card" data-ranked="{{ 'true' if game.home_rank or game.away_rank else 'false' }}">
                <div class="border rounded p-3 h-100 opacity-50">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <small class="text-muted">{{ game.time or 'TBD' }}</small>
                        <span class="badge bg-warning text-dark">{{ game.status|capitalize }}</span>
                    </div>
                    <div class="mb-1">
                        {% if game.away_rank %}<span class="badge bg-maroon me-1">{{ game.away_rank }}</span>{% endif %}
                        <a href="/team/{{ game.away_team_id }}" class="team-link">{{ game.away_team_name }}</a>
                    </div>
                    <div>
                        {% if game.home_rank %}<span class="badge bg-maroon me-1">{{ game.home_rank }}</span>{% endif %}
                        <a href="/team/{{ game.home_team_id }}" class="team-link">{{ game.home_team_name }}</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- No Games Found -->
{% if not completed_games and not in_progress_games and not scheduled_games %}
<div class="card">
    <div class="card-body text-center py-5">
        <i class="bi bi-calendar-x display-1 text-muted"></i>
        <h4 class="mt-3">No Games Found</h4>
        <p class="text-muted">
            No games on {{ display_date.strftime('%B %d, %Y') }}
            {% if selected_conference %}in {{ selected_conference }}{% endif %}
        </p>
        <a href="/scores?date={{ prev_date }}" class="btn btn-maroon">
            <i class="bi bi-chevron-left"></i> Check Previous Day
        </a>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
function goToDate(dateStr) {
    const conf = document.getElementById('conferenceFilter').value;
    let url = '/scores?date=' + dateStr;
    if (conf) {
        url += '&conference=' + encodeURIComponent(conf);
    }
    window.location.href = url;
}

function updateFilters() {
    const date = '{{ selected_date }}';
    goToDate(date);
}

function filterGames(mode) {
    // Update button states
    document.querySelectorAll('.btn-group .btn').forEach(b => b.classList.remove('active'));
    document.getElementById('filter-' + mode).classList.add('active');

    const cards = document.querySelectorAll('.game-card');
    let visibleCount = 0;

    cards.forEach(card => {
        if (mode === 'ranked') {
            const isRanked = card.dataset.ranked === 'true';
            card.style.display = isRanked ? '' : 'none';
            if (isRanked) visibleCount++;
        } else {
            card.style.display = '';
            visibleCount++;
        }
    });

    // Sort ranked games to top within each section
    document.querySelectorAll('.row.g-0').forEach(row => {
        const gameCards = Array.from(row.querySelectorAll('.game-card'));
        if (gameCards.length === 0) return;
        
        gameCards.sort((a, b) => {
            const aRanked = a.dataset.ranked === 'true';
            const bRanked = b.dataset.ranked === 'true';
            if (aRanked && !bRanked) return -1;
            if (!aRanked && bRanked) return 1;
            // Both ranked: sort by best rank (lowest number first)
            const aRank = Math.min(parseInt(a.dataset.homeRank) || 999, parseInt(a.dataset.awayRank) || 999);
            const bRank = Math.min(parseInt(b.dataset.homeRank) || 999, parseInt(b.dataset.awayRank) || 999);
            return aRank - bRank;
        });

        gameCards.forEach(card => row.appendChild(card));
    });

    // Hide empty sections
    document.querySelectorAll('.card.mb-4').forEach(section => {
        const visCards = section.querySelectorAll('.game-card:not([style*="display: none"])');
        if (section.querySelector('.game-card')) {
            section.style.display = visCards.length > 0 ? '' : 'none';
        }
    });
}

// Sort ranked games to top on initial load
document.addEventListener('DOMContentLoaded', () => filterGames('all'));
</script>
{% endblock %}
