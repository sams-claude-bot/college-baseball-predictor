{% extends "base.html" %}

{% block title %}Accuracy Trends - College Baseball Predictor{% endblock %}

{% block content %}
<div class="mb-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/models">Models</a></li>
            <li class="breadcrumb-item active">Accuracy Trends</li>
        </ol>
    </nav>
    <h1 class="h3">
        <i class="bi bi-graph-up-arrow"></i> Model Accuracy Trends
    </h1>
    <p class="text-muted">Track how each model performs over time</p>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    {% for model in cumulative[:4] %}
    <div class="col-md-3 col-6 mb-3">
        <div class="card h-100">
            <div class="card-body text-center">
                <h5 class="card-title text-capitalize">{{ model.model }}</h5>
                <h2 class="{% if model.accuracy >= 60 %}text-success{% elif model.accuracy >= 50 %}text-warning{% else %}text-danger{% endif %}">
                    {{ model.accuracy }}%
                </h2>
                <small class="text-muted">{{ model.correct }}/{{ model.total }} correct</small>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Rolling Accuracy (7-day window) -->
<div class="card mb-4">
    <div class="card-header bg-maroon">
        <i class="bi bi-graph-up"></i> Rolling Accuracy (Last 7 Days)
    </div>
    <div class="card-body">
        {% if rolling_data %}
        <div style="position: relative; height: 350px; width: 100%;">
            <canvas id="rollingChart"></canvas>
        </div>
        <p class="text-muted small mt-2 mb-0">
            <i class="bi bi-info-circle"></i> Shows accuracy over the last 7 days of games
        </p>
        {% else %}
        <div class="text-center py-5">
            <i class="bi bi-hourglass-split display-4 text-muted"></i>
            <p class="mt-3 text-muted">No accuracy data yet</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Cumulative Accuracy -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-bar-chart"></i> Cumulative Accuracy (Season-to-Date)
    </div>
    <div class="card-body">
        {% if rolling_data %}
        <div style="position: relative; height: 350px; width: 100%;">
            <canvas id="cumulativeChart"></canvas>
        </div>
        <p class="text-muted small mt-2 mb-0">
            <i class="bi bi-info-circle"></i> Overall accuracy from season start
        </p>
        {% else %}
        <p class="text-muted text-center">No data yet</p>
        {% endif %}
    </div>
</div>

<!-- Leaderboard -->
<div class="row">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-trophy"></i> Model Leaderboard
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Model</th>
                            <th class="text-center">Accuracy</th>
                            <th class="text-center">Record</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for model in cumulative %}
                        <tr>
                            <td>
                                {% if loop.index == 1 %}ðŸ¥‡
                                {% elif loop.index == 2 %}ðŸ¥ˆ
                                {% elif loop.index == 3 %}ðŸ¥‰
                                {% else %}{{ loop.index }}
                                {% endif %}
                            </td>
                            <td class="text-capitalize"><strong>{{ model.model }}</strong></td>
                            <td class="text-center">
                                <span class="badge {% if model.accuracy >= 60 %}bg-success{% elif model.accuracy >= 50 %}bg-warning text-dark{% else %}bg-danger{% endif %}">
                                    {{ model.accuracy }}%
                                </span>
                            </td>
                            <td class="text-center text-muted">{{ model.correct }}-{{ model.total - model.correct }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-calendar3"></i> Daily Breakdown
            </div>
            <div class="card-body p-0">
                {% if dates %}
                <table class="table table-sm mb-0">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th class="text-center">Best Model</th>
                            <th class="text-center">Games</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for date in dates|reverse %}
                        {% set best_model = None %}
                        {% set best_acc = 0 %}
                        {% set total_games = 0 %}
                        {% for model, days in daily_data.items() %}
                            {% for day in days %}
                                {% if day.date == date %}
                                    {% if day.accuracy > best_acc %}
                                        {% set best_model = model %}
                                        {% set best_acc = day.accuracy %}
                                    {% endif %}
                                    {% if total_games == 0 %}
                                        {% set total_games = day.total %}
                                    {% endif %}
                                {% endif %}
                            {% endfor %}
                        {% endfor %}
                        <tr>
                            <td>{{ date }}</td>
                            <td class="text-center text-capitalize">
                                {% if daily_data.ensemble %}
                                    {% for day in daily_data.ensemble %}
                                        {% if day.date == date %}
                                            {{ day.correct }}/{{ day.total }} ({{ day.accuracy }}%)
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    â€”
                                {% endif %}
                            </td>
                            <td class="text-center">
                                {% if daily_data.ensemble %}
                                    {% for day in daily_data.ensemble %}
                                        {% if day.date == date %}
                                            {{ day.total }}
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    â€”
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted text-center py-3">No daily data yet</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Model Comparison Note -->
<div class="card mt-4">
    <div class="card-body">
        <h6><i class="bi bi-info-circle"></i> Understanding the Charts</h6>
        <ul class="mb-0 small text-muted">
            <li><strong>Rolling Accuracy:</strong> Shows each model's accuracy over the last 30 predictions. Smooths out day-to-day variance.</li>
            <li><strong>Cumulative Accuracy:</strong> Shows overall accuracy from season start. More stable but slower to react to changes.</li>
            <li><strong>Early Season Note:</strong> With few games, accuracy will be volatile. Trends become meaningful after 50+ predictions per model.</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
{% if rolling_data %}
const rollingData = {{ rolling_data|tojson }};
const dates = {{ dates|tojson }};

// Color palette for models
const modelColors = {
    'ensemble': '#5D1725',
    'neural': '#2563eb', 
    'elo': '#E74C3C',
    'pythagorean': '#F39C12',
    'log5': '#27AE60',
    'advanced': '#9B59B6',
    'pitching': '#1ABC9C',
    'conference': '#E67E22',
    'prior': '#3498DB',
    'poisson': '#95A5A6',
    'xgboost': '#16A085',
    'lightgbm': '#8E44AD'
};

// Rolling accuracy chart (7-day window, one point per day)
const shiftDate = (dateStr, days) => {
    const d = new Date(dateStr + 'T00:00:00');
    d.setDate(d.getDate() + days);
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, '0');
    const day = String(d.getDate()).padStart(2, '0');
    return `${y}-${m}-${day}`;
};

const rollingDatasets = [];
for (const [model, points] of Object.entries(rollingData)) {
    if (points.length === 0) continue;
    let adjustedPoints = points;
    // Defensive fix: if neural series is offset +1 day, pull it back.
    if (model === 'neural' && points.length > 0 && dates.length > 1 && points[0].date > dates[1]) {
        adjustedPoints = points.map(p => ({...p, date: shiftDate(p.date, -1)}));
    }
    const byDate = Object.fromEntries(adjustedPoints.map(p => [p.date, p]));
    const dayGames = dates.map(d => (byDate[d] ? byDate[d].day_games : null));
    rollingDatasets.push({
        label: model.charAt(0).toUpperCase() + model.slice(1),
        data: dates.map(d => (byDate[d] ? byDate[d].rolling : null)),
        dayGames,
        borderColor: modelColors[model] || '#777',
        backgroundColor: 'transparent',
        borderWidth: (model === 'ensemble' || model === 'neural') ? 3 : 1.5,
        pointRadius: 5,
        pointHoverRadius: 7,
        spanGaps: false,
        tension: 0.3
    });
}

rollingDatasets.sort((a, b) => {
    const priority = {'Ensemble': 2, 'Neural': 1};
    return (priority[a.label] || 0) - (priority[b.label] || 0);
});

new Chart(document.getElementById('rollingChart'), {
    type: 'line',
    data: { labels: dates, datasets: rollingDatasets },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: { mode: 'index', intersect: false },
        plugins: {
            legend: { position: 'bottom', labels: { usePointStyle: true } },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        const games = ctx.dataset.dayGames?.[ctx.dataIndex] ?? '?';
                        return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '% (' + games + ' games that day)';
                    }
                }
            }
        },
        scales: {
            x: { type: 'category', title: { display: true, text: 'Date' } },
            y: { min: 0, max: 100, title: { display: true, text: 'Rolling 7-Day Accuracy' }, ticks: { callback: v => v + '%' } }
        }
    }
});

// Cumulative accuracy chart (season-to-date)
const cumulativeDatasets = [];
for (const [model, points] of Object.entries(rollingData)) {
    if (points.length === 0) continue;
    let adjustedPoints = points;
    if (model === 'neural' && points.length > 0 && dates.length > 1 && points[0].date > dates[1]) {
        adjustedPoints = points.map(p => ({...p, date: shiftDate(p.date, -1)}));
    }
    const byDate = Object.fromEntries(adjustedPoints.map(p => [p.date, p]));
    const gamesCum = dates.map(d => (byDate[d] ? byDate[d].games : null));
    cumulativeDatasets.push({
        label: model.charAt(0).toUpperCase() + model.slice(1),
        data: dates.map(d => (byDate[d] ? byDate[d].cumulative : null)),
        gamesCum,
        borderColor: modelColors[model] || '#777',
        backgroundColor: 'transparent',
        borderWidth: (model === 'ensemble' || model === 'neural') ? 3 : 1.5,
        pointRadius: 5,
        pointHoverRadius: 7,
        spanGaps: false,
        tension: 0.3
    });
}

// Sort so ensemble and neural are drawn on top (last)
cumulativeDatasets.sort((a, b) => {
    const priority = {'Ensemble': 2, 'Neural': 1};
    return (priority[a.label] || 0) - (priority[b.label] || 0);
});

new Chart(document.getElementById('cumulativeChart'), {
    type: 'line',
    data: { labels: dates, datasets: cumulativeDatasets },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            mode: 'index',
            intersect: false
        },
        plugins: {
            legend: { 
                position: 'bottom',
                labels: { usePointStyle: true }
            },
            tooltip: {
                callbacks: {
                    label: ctx => {
                        const games = ctx.dataset.gamesCum?.[ctx.dataIndex] ?? '?';
                        return ctx.dataset.label + ': ' + ctx.parsed.y.toFixed(1) + '% (' + games + ' games)';
                    }
                }
            }
        },
        scales: {
            x: { 
                type: 'category',
                title: { display: true, text: 'Date' }
            },
            y: { 
                min: 0,
                max: 100,
                title: { display: true, text: 'Cumulative Accuracy %' },
                ticks: { callback: v => v + '%' }
            }
        }
    }
});
{% endif %}
</script>
{% endblock %}
