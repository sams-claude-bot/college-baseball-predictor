{% extends "base.html" %}

{% block title %}Rankings - College Baseball Predictor{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0"><i class="bi bi-list-ol"></i> Rankings</h1>
    <div class="filter-bar">
        <select class="form-select" onchange="updateRankingsFilters()" id="confFilter">
            <option value="">All Conferences</option>
            {% for conf in conferences %}
            <option value="{{ conf }}" {% if selected_conference == conf %}selected{% endif %}>{{ conf }}</option>
            {% endfor %}
        </select>
        {% if history_dates %}
        <select class="form-select" id="weekSelector" onchange="updateRankingsFilters()">
            <option value="">Current Rankings</option>
            {% for date in history_dates %}
            <option value="{{ date }}" {% if selected_date == date %}selected{% endif %}>{{ date }}</option>
            {% endfor %}
        </select>
        {% endif %}
    </div>
</div>

<div class="row">
    <!-- D1Baseball / AP Top 25 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header bg-maroon">
                <i class="bi bi-trophy-fill"></i> 
                {% if selected_date %}D1Baseball Rankings ({{ selected_date }}){% else %}D1Baseball Top 25{% endif %}
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width: 50px;" class="text-center">#</th>
                                <th>Team</th>
                                <th class="text-center">Record</th>
                                <th class="text-end">Elo</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% set rankings = historical if historical else top_25 %}
                            {% for team in rankings %}
                            {% set tid = team.id if team.id else team.team_id %}
                            <tr class="{% if tid not in elo_ids %}table-light{% endif %}">
                                <td class="text-center">
                                    <span class="badge bg-maroon">{{ team.rank if team.rank else team.current_rank }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ team_logo(tid) }}" height="24" class="me-2" onerror="this.style.display='none'">
                                        <div>
                                            <a href="/team/{{ tid }}" class="team-link"><strong>{{ team.name }}</strong></a>
                                            <br><small class="text-muted">{{ team.conference or '' }}</small>
                                            {% if tid not in elo_ids %}
                                            <span class="badge bg-secondary ms-1" title="Not in Elo Top 25">D1BB only</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">
                                    {% if team.wins is defined %}{{ team.wins }}-{{ team.losses }}{% else %}—{% endif %}
                                </td>
                                <td class="text-end">
                                    {% if team.elo_rating %}{{ team.elo_rating|round(0)|int }}{% else %}—{% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Elo Top 25 -->
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #2563eb; color: white;">
                <span><i class="bi bi-graph-up-arrow"></i> Elo Top 25</span>
                <a href="/api/elo-card?download=1" class="btn btn-sm btn-light" title="Download as image">
                    <i class="bi bi-download"></i> Share
                </a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-sm mb-0">
                        <thead>
                            <tr>
                                <th style="width: 50px;" class="text-center">#</th>
                                <th>Team</th>
                                <th class="text-center">Record</th>
                                <th class="text-end">Elo</th>
                                <th class="text-center">SOS</th>
                                <th class="text-center">AP</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in elo_top_25 %}
                            <tr class="{% if team.team_id not in ap_ids %}table-light{% endif %}">
                                <td class="text-center">
                                    <span class="badge" style="background-color: #2563eb;">{{ team.elo_rank }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <img src="{{ team_logo(team.team_id) }}" height="24" class="me-2" onerror="this.style.display='none'">
                                        <div>
                                            <a href="/team/{{ team.team_id }}" class="team-link"><strong>{{ team.name }}</strong></a>
                                            <br><small class="text-muted">{{ team.conference or '' }}</small>
                                            {% if team.team_id not in ap_ids %}
                                            <span class="badge bg-secondary ms-1" title="Not in D1BB Top 25">Elo only</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="text-center">{{ team.wins }}-{{ team.losses }}</td>
                                <td class="text-end"><strong>{{ team.rating|round(0)|int }}</strong></td>
                                <td class="text-center">
                                    {% if team.sos %}
                                    <span class="{% if team.sos >= 1550 %}text-danger{% elif team.sos >= 1500 %}text-warning{% else %}text-muted{% endif %}">{{ team.sos }}</span>
                                    {% else %}—{% endif %}
                                </td>
                                <td class="text-center">
                                    {% if team.current_rank %}
                                    <span class="badge bg-maroon">{{ team.current_rank }}</span>
                                    {% else %}
                                    <span class="text-muted">NR</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Model Power Rankings -->
{% if power_rankings %}
{% set model_abbrev = {
    'prior': 'Prior', 'elo': 'Elo', 'conference': 'Conf', 'advanced': 'Adv',
    'log5': 'Log5', 'poisson': 'Pois', 'pythagorean': 'Pyth', 'lightgbm': 'LGB',
    'xgboost': 'XGB', 'pitching': 'Pitch', 'neural': 'NN'
} %}
{% set model_weights = {
    'prior': 16, 'elo': 15, 'conference': 12, 'advanced': 12,
    'log5': 10, 'poisson': 8, 'pythagorean': 8, 'lightgbm': 8,
    'xgboost': 6, 'pitching': 5, 'neural': 0
} %}
<div class="card mt-4">
    <div class="card-header" style="background: linear-gradient(135deg, #059669, #047857); color: white;">
        <div class="d-flex justify-content-between align-items-center">
            <span><i class="bi bi-lightning-charge-fill"></i> Model Power Rankings</span>
            <small class="opacity-75">Round-robin simulation • {{ power_rankings|length }} teams • {{ power_model_names|length }} models • Updated {{ power_rankings_date or 'N/A' }}</small>
        </div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover table-sm mb-0" style="font-size: 0.85rem;">
                <thead>
                    <tr>
                        <th style="width: 40px;" class="text-center">#</th>
                        <th>Team</th>
                        <th class="text-center d-none d-md-table-cell">Rec</th>
                        <th class="text-end">Composite</th>
                        {% for mn in power_model_names %}
                        <th class="text-center d-none d-lg-table-cell" style="width: 52px;" title="{{ mn }} ({{ model_weights.get(mn, 0) }}% weight)">
                            <span style="font-size: 0.75rem;">{{ model_abbrev.get(mn, mn[:4]) }}</span>
                        </th>
                        {% endfor %}
                        <th class="text-center" style="width: 55px;">Move</th>
                        <th class="text-center d-none d-md-table-cell" style="width: 40px;">AP</th>
                        <th class="text-center d-none d-md-table-cell" style="width: 40px;">Elo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for team in power_rankings %}
                    <tr>
                        <td class="text-center">
                            <span class="badge" style="background-color: #059669;">{{ team.rank }}</span>
                        </td>
                        <td style="white-space: nowrap;">
                            <a href="/team/{{ team.team_id }}" class="team-link"><strong>{{ team.team_name }}</strong></a>
                            <br><small class="text-muted">{{ team.conference or '' }}</small>
                        </td>
                        <td class="text-center d-none d-md-table-cell">
                            {{ team.wins }}-{{ team.losses }}
                        </td>
                        <td class="text-end">
                            <strong>{{ '%.1f'|format(team.power_score * 100) }}%</strong>
                            <div class="progress" style="height: 4px; width: 50px; display: inline-block; vertical-align: middle; margin-left: 3px;">
                                <div class="progress-bar bg-success" style="width: {{ (team.power_score * 100)|round|int }}%"></div>
                            </div>
                        </td>
                        {% for mn in power_model_names %}
                        <td class="text-center d-none d-lg-table-cell" style="font-size: 0.78rem;">
                            {% set detail = power_model_detail.get(team.team_id, {}).get(mn) %}
                            {% if detail %}
                                {% set wp = detail.avg_win_prob %}
                                <span class="{% if wp >= 0.75 %}text-success fw-bold{% elif wp >= 0.60 %}text-success{% elif wp < 0.45 %}text-danger{% else %}text-muted{% endif %}"
                                      title="#{{ detail.model_rank }} in {{ mn }}">
                                    {{ '%.0f'|format(wp * 100) }}
                                </span>
                            {% else %}
                                <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        {% endfor %}
                        <td class="text-center">
                            {% if team.rank_change is not none and team.rank_change != 0 %}
                                {% if team.rank_change > 0 %}
                                <span class="text-success"><i class="bi bi-arrow-up"></i> {{ team.rank_change }}</span>
                                {% else %}
                                <span class="text-danger"><i class="bi bi-arrow-down"></i> {{ team.rank_change|abs }}</span>
                                {% endif %}
                            {% elif team.rank_change == 0 %}
                                <span class="text-muted">–</span>
                            {% else %}
                                <span class="badge bg-success">NEW</span>
                            {% endif %}
                        </td>
                        <td class="text-center d-none d-md-table-cell">
                            {% if team.ap_rank %}
                            <span class="badge bg-maroon">{{ team.ap_rank }}</span>
                            {% else %}
                            <span class="text-muted">NR</span>
                            {% endif %}
                        </td>
                        <td class="text-center d-none d-md-table-cell">
                            {% if team.elo_rank %}
                            <span class="badge" style="background-color: #2563eb;">{{ team.elo_rank }}</span>
                            {% else %}
                            <span class="text-muted">NR</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Legend -->
<div class="card mt-3">
    <div class="card-body py-2">
        <div class="d-flex flex-wrap gap-3 align-items-center small">
            <strong>Legend:</strong>
            <span><span class="badge bg-secondary">D1BB only</span> Ranked by D1Baseball but not in Elo Top 25</span>
            <span><span class="badge bg-secondary">Elo only</span> In Elo Top 25 but not ranked by D1Baseball</span>
            {% if power_rankings %}
            <span><span class="badge" style="background-color: #059669; color: white;">Power</span> Model-simulated round-robin ranking (all teams vs all teams)</span>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function updateRankingsFilters() {
    const selects = document.querySelectorAll('select');
    let conference = '', week = '';
    selects.forEach(s => {
        if (s.id === 'weekSelector') week = s.value;
        else if (s.options[0] && s.options[0].text === 'All Conferences') conference = s.value;
    });
    let params = [];
    if (conference) params.push('conference=' + encodeURIComponent(conference));
    if (week) params.push('week=' + encodeURIComponent(week));
    window.location.href = '/rankings?' + params.join('&');
}
</script>
{% endblock %}
